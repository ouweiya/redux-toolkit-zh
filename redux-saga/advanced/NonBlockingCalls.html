<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-redux-saga/advanced/NonBlockingCalls" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">非阻塞调用 | Redux Toolkit</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ouweiya.github.io/redux-toolkit-zh/img/redux-logo-landscape.png"><meta data-rh="true" name="twitter:image" content="https://ouweiya.github.io/redux-toolkit-zh/img/redux-logo-landscape.png"><meta data-rh="true" property="og:url" content="https://ouweiya.github.io/redux-toolkit-zh/redux-saga/advanced/NonBlockingCalls"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="非阻塞调用 | Redux Toolkit"><meta data-rh="true" name="description" content="在上一节中，我们看到了如何使用 take Effect 更好地在一个中心位置描述一个非平凡的流程。"><meta data-rh="true" property="og:description" content="在上一节中，我们看到了如何使用 take Effect 更好地在一个中心位置描述一个非平凡的流程。"><link data-rh="true" rel="icon" href="/redux-toolkit-zh/img/favicon/favicon.ico"><link data-rh="true" rel="canonical" href="https://ouweiya.github.io/redux-toolkit-zh/redux-saga/advanced/NonBlockingCalls"><link data-rh="true" rel="alternate" href="https://ouweiya.github.io/redux-toolkit-zh/redux-saga/advanced/NonBlockingCalls" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://ouweiya.github.io/redux-toolkit-zh/redux-saga/advanced/NonBlockingCalls" hreflang="x-default"><link rel="stylesheet" href="/redux-toolkit-zh/assets/css/styles.2037b555.css">
<script src="/redux-toolkit-zh/assets/js/runtime~main.9623f1e0.js" defer="defer"></script>
<script src="/redux-toolkit-zh/assets/js/main.15288abb.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/redux-toolkit-zh/"><div class="navbar__logo"><img src="/redux-toolkit-zh/img/redux.svg" alt="Redux Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/redux-toolkit-zh/img/redux.svg" alt="Redux Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Redux Toolkit 中文文档</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/redux-toolkit-zh/introduction/getting-started">开始使用</a><a class="navbar__item navbar__link" href="/redux-toolkit-zh/tutorials/overview">教程</a><a class="navbar__item navbar__link" href="/redux-toolkit-zh/usage/usage-guide">使用指南</a><a class="navbar__item navbar__link" href="/redux-toolkit-zh/api/configureStore">API</a><a class="navbar__item navbar__link" href="/redux-toolkit-zh/rtk-query/overview">RTK 查询</a><a class="navbar__item navbar__link" href="/redux-toolkit-zh/reselect/introduction/getting-started">Reselect 中文</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/redux-toolkit-zh/redux-saga/About">Redux-Saga 中文</a><a href="https://github.com/ouweiya/redux-toolkit-zh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/About">关于 Redux-Saga</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/redux-toolkit-zh/redux-saga/introduction/GettingStarted">介绍</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/introduction/GettingStarted">入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/introduction/BeginnerTutorial">初级教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/introduction/SagaBackground">Saga 背景</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/redux-toolkit-zh/redux-saga/basics/DeclarativeEffects">基本概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/basics/DeclarativeEffects">声明式效果</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/basics/DispatchingActions">分发操作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/basics/Effect">效果</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/basics/ErrorHandling">错误处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/basics/UsingSagaHelpers">使用 Saga 辅助函数</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/redux-toolkit-zh/redux-saga/advanced/Channels">高级概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/Channels">通道</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/ComposingSagas">编写 Sagas</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/Concurrency">并发性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/ForkModel">分支模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/FutureActions">未来的操作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/NonBlockingCalls">非阻塞调用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/RacingEffects">竞态效应</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/RootSaga">根 Saga</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/RunningTasksInParallel">并行运行任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/TaskCancellation">任务取消</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/Testing">测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/redux-toolkit-zh/redux-saga/advanced/UsingRunSaga">使用 Run Saga</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/recipes">食谱</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/ExternalResources">外部资源</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/Troubleshooting">故障排除</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/Glossary">术语表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/redux-toolkit-zh/redux-saga/api">API 参考</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/redux-toolkit-zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">高级概念</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">非阻塞调用</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>非阻塞调用</h1>
<p>在上一节中，我们看到了如何使用 <code>take</code> Effect 更好地在一个中心位置描述一个非平凡的流程。</p>
<p>回顾一下登录流程的例子：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// ... 执行登录逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGOUT&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// ... 执行登出逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们完成这个例子并实现实际的登录/登出逻辑。假设我们有一个 API，它允许我们在远程服务器上授权用户。如果授权成功，服务器将返回一个授权令牌，我们的应用程序将使用 DOM 存储来存储它（假设我们的 API 提供了另一个用于 DOM 存储的服务）。</p>
<p>当用户登出时，我们将删除之前存储的授权令牌。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="第一次尝试">第一次尝试<a href="#第一次尝试" class="hash-link" aria-label="第一次尝试的直接链接" title="第一次尝试的直接链接">​</a></h3>
<p>到目前为止，我们已经有了所有需要实现上述流程的 Effects。我们可以使用 <code>take</code> Effect 在存储中等待特定的动作。我们可以使用 <code>call</code> Effect 进行异步调用。最后，我们可以使用 <code>put</code> Effect 向存储中派发动作。</p>
<p>让我们试一试：</p>
<blockquote>
<p>注意：下面的代码有一个微妙的问题。请确保阅读到本节的最后。</p>
</blockquote>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token imports"> take</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> call</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> put </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;redux-saga/effects&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Api</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;...&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">user</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_SUCCESS&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">catch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_ERROR&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_REQUEST&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">storeItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGOUT&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">clearItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;token&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先，我们创建了一个单独的 Generator <code>authorize</code>，它将执行实际的 API 调用并在成功时通知 Store。</p>
<p><code>loginFlow</code> 在 <code>while (true)</code> 循环内实现其整个流程，这意味着一旦我们到达流程的最后一步（<code>LOGOUT</code>），我们就会开始新的迭代，等待新的 <code>LOGIN_REQUEST</code> 动作。</p>
<p><code>loginFlow</code> 首先等待一个 <code>LOGIN_REQUEST</code> 动作。然后，它在动作负载中检索凭据（<code>user</code> 和 <code>password</code>），并对 <code>authorize</code> 任务进行 <code>call</code>。</p>
<p>如你所见，<code>call</code> 不仅用于调用返回 Promise 的函数。我们也可以用它来调用其他 Generator 函数。在上面的例子中，<strong><code>loginFlow</code> 将等待 authorize 直到它终止并返回</strong>（即在执行 api 调用、派发动作然后将令牌返回给 <code>loginFlow</code> 之后）。</p>
<p>如果 API 调用成功，<code>authorize</code> 将派发一个 <code>LOGIN_SUCCESS</code> 动作，然后返回获取的令牌。如果出现错误，它将派发一个 <code>LOGIN_ERROR</code> 动作。</p>
<p>如果对 <code>authorize</code> 的调用成功，<code>loginFlow</code> 将在 DOM 存储中存储返回的令牌，并等待一个 <code>LOGOUT</code> 动作。当用户登出时，我们删除存储的令牌并等待新的用户登录。</p>
<p>如果 <code>authorize</code> 失败，它将返回 <code>undefined</code>，这将导致 <code>loginFlow</code> 跳过前面的过程并等待新的 <code>LOGIN_REQUEST</code> 动作。</p>
<p>注意整个逻辑都存储在一个地方。新的开发者阅读我们的代码时不必在各个地方来回跳 转以理解控制流程。这就像阅读一个同步算法：步骤按照自然顺序排列。我们有函数调用其他函数并等待它们的结果。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="但是上述方法仍然存在一个微妙的问题">但是上述方法仍然存在一个微妙的问题<a href="#但是上述方法仍然存在一个微妙的问题" class="hash-link" aria-label="但是上述方法仍然存在一个微妙的问题的直接链接" title="但是上述方法仍然存在一个微妙的问题的直接链接">​</a></h3>
<p>假设当 <code>loginFlow</code> 正在等待以下调用解决时：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>用户点击了 <code>Logout</code> 按钮，导致派发了一个 <code>LOGOUT</code> 动作。</p>
<p>以下示例说明了事件的假设顺序：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">UI                              loginFlow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">--------------------------------------------------------</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LOGIN_REQUEST...................call authorize.......... 等待解决</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">........................................................</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">........................................................</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LOGOUT.................................................. 错过了！</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">........................................................</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">................................authorize 返回了........ 派发一个 `LOGIN_SUCCESS`!!</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">........................................................</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当 <code>loginFlow</code> 在 <code>authorize</code> 调用上被阻塞时，调用和响应之间发生的任何 <code>LOGOUT</code> 都会被错过，因为 <code>loginFlow</code> 还没有执行 <code>yield take(&#x27;LOGOUT&#x27;)</code>。</p>
<p>上述代码的问题在于 <code>call</code> 是一个阻塞效应。也就是说，生成器在调用结束之前不能执行/处理其他任何事情。但在我们的情况下，我们不仅希望 <code>loginFlow</code> 执行授权调用，还希望在此调用中间观察可能发生的 <code>LOGOUT</code> 动作。这是因为 <code>LOGOUT</code> 是与 <code>authorize</code> 调用 <em>并发</em> 的。</p>
<p>所以，我们需要的是一种启动 <code>authorize</code> 而不阻塞 <code>loginFlow</code> 的方法，这样 <code>loginFlow</code> 就可以继续并观察可能的/并发的 <code>LOGOUT</code> 动作。</p>
<p>为了表达非阻塞调用，库提供了另一个效应：<a href="https://redux-saga.js.org/docs/api/index.html#forkfn-args" target="_blank" rel="noopener noreferrer"><code>fork</code></a>。当我们 fork 一个 <em>任务</em> 时，任务在后台启动，调用者可以在不等待 fork 的任务结束的情况下继续其流程。</p>
<p>所以，为了让 <code>loginFlow</code> 不错过并发的 <code>LOGOUT</code>，我们不能 <code>call</code> <code>authorize</code> 任务，而必须 <code>fork</code> 它。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token imports"> fork</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> call</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> take</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> put </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;redux-saga/effects&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token spread operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// 非阻塞调用，这里返回的值是什么？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">??</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fork</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token spread operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token spread operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在的问题是，由于我们的 <code>authorize</code> 动作在后台启动，我们无法获取 <code>token</code> 结果（因为我们必须等待它）。所以我们需要将 token 存储操作移动到 <code>authorize</code> 任务中。</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token imports"> fork</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> call</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> take</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> put </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;redux-saga/effects&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Api</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;...&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">user</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_SUCCESS&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">storeItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">catch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_ERROR&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_REQUEST&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fork</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGOUT&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_ERROR&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">clearItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;token&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们也在做 <code>yield take([&#x27;LOGOUT&#x27;, &#x27;LOGIN_ERROR&#x27;])</code>。这意味着我们正在同时监视两个动作：</p>
<ul>
<li>
<p>如果 <code>authorize</code> 任务在用户登出之前成功，它将分发一个 <code>LOGIN_SUCCESS</code> 动作，然后终止。我们的 <code>loginFlow</code> saga 将只等待未来的 <code>LOGOUT</code> 动作（因为 <code>LOGIN_ERROR</code> 永远不会发生）。</p>
</li>
<li>
<p>如果 <code>authorize</code> 在用户登出之前失败，它将分发一个 <code>LOGIN_ERROR</code> 动作，然后终止。所以 <code>loginFlow</code> 会在 <code>LOGOUT</code> 之前接收到 <code>LOGIN_ERROR</code>，然后它将进入另一个 <code>while</code> 迭代，并等待下一个 <code>LOGIN_REQUEST</code> 动作。</p>
</li>
<li>
<p>如果用户在 <code>authorize</code> 结束之前登出，那么 <code>loginFlow</code> 将接收到一个 <code>LOGOUT</code> 动作，并等待下一个 <code>LOGIN_REQUEST</code>。</p>
</li>
</ul>
<p>注意，对 <code>Api.clearItem</code> 的调用应该是幂等的。如果 <code>authorize</code> 调用没有存储令牌，它将没有效果。<code>loginFlow</code> 确保在等待下一次登录之前，存储中不会有令牌。</p>
<p>但我们还没有完成。如果我们在 API 调用过程中接收到 <code>LOGOUT</code>，我们必须<strong>取消</strong> <code>authorize</code> 过程，否则我们将有两个并行的任务：<code>authorize</code> 任务将继续运行，并在成功（或失败）后，分发一个 <code>LOGIN_SUCCESS</code>（或 <code>LOGIN_ERROR</code>）动作，导致状态不一致。</p>
<p>为了取消一个 forked 任务，我们使用一个专用的 Effect <a href="https://redux-saga.js.org/docs/api/index.html#canceltask" target="_blank" rel="noopener noreferrer"><code>cancel</code></a></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token imports"> take</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> put</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> call</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> fork</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> cancel </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;redux-saga/effects&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">loginFlow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_REQUEST&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// fork 返回一个 Task 对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> task </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fork</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> action </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGOUT&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_ERROR&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">action</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGOUT&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">cancel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">task</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">clearItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;token&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>yield fork</code> 产生一个 <a href="https://redux-saga.js.org/docs/api/index.html#task" target="_blank" rel="noopener noreferrer">Task 对象</a>。我们将返回的对象赋值给一个本地常量 <code>task</code>  。稍后，如果我们接收到一个 <code>LOGOUT</code> 动作，我们将该任务传递给 <code>cancel</code> Effect。如果任务仍在运行，它将被中止。如果任务已经完成，那么什么都不会发生，取消将导致无操作。最后，如果任务以错误完成，那么我们什么都不做，因为我们知道任务已经完成。</p>
<p>我们<em>几乎</em>完成了（并发并不那么简单；你必须认真对待）。</p>
<p>假设当我们接收到一个 <code>LOGIN_REQUEST</code> 动作时，我们的 reducer 将某个 <code>isLoginPending</code> 标志设置为 true，以便在 UI 中显示一些消息或旋转器。如果我们在 API 调用过程中接收到 <code>LOGOUT</code> 并通过<em>杀死它</em>（即任务立即停止）来中止任务，那么我们可能会再次处于不一致的状态。我们仍然将 <code>isLoginPending</code> 设置为 true，我们的 reducer 将等待一个结果动作（<code>LOGIN_SUCCESS</code> 或 <code>LOGIN_ERROR</code>）。</p>
<p>幸运的是，<code>cancel</code> Effect 不会粗暴地杀死我们的 <code>authorize</code> 任务。相反，它会给它一个执行清理逻辑的机会。被取消的任务可以在其 <code>finally</code> 块中处理任何取消逻辑（以及任何其他类型的完成）。由于 finally 块在任何类型的完成（正常返回、错误或强制取消）上执行，所以有一个 Effect <code>cancelled</code>，你可以使用它如果你想以特殊的方式处理取消：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token imports"> take</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> call</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> put</span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token imports"> cancelled </span><span class="token imports punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;redux-saga/effects&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword module" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Api</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;...&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">user</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">authorize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> password</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_SUCCESS&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token maybe-class-name">Api</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">storeItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> token</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">catch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">put</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token literal-property property">type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;LOGIN_ERROR&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">yield</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">cancelled</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// ... 在这里放置特殊的取消处理代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你可能已经注意到，我们还没有做任何关于清除我们的 <code>isLoginPending</code> 状态的事情。对此，至少有两种可能 的解决方案：</p>
<ul>
<li>分发一个专用的动作 <code>RESET_LOGIN_PENDING</code></li>
<li>让 reducer 在 <code>LOGOUT</code> 动作上清除 <code>isLoginPending</code></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ouweiya/redux-toolkit-zh/tree/master/docs/redux-saga/advanced/NonBlockingCalls.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/redux-toolkit-zh/redux-saga/advanced/FutureActions"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">未来的操作</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/redux-toolkit-zh/redux-saga/advanced/RacingEffects"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">竞态效应</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#第一次尝试" class="table-of-contents__link toc-highlight">第一次尝试</a></li><li><a href="#但是上述方法仍然存在一个微妙的问题" class="table-of-contents__link toc-highlight">但是上述方法仍然存在一个微妙的问题</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/redux-toolkit-zh/introduction/getting-started">开始使用</a></li><li class="footer__item"><a class="footer__link-item" href="/redux-toolkit-zh/tutorials/overview">教程</a></li><li class="footer__item"><a class="footer__link-item" href="/redux-toolkit-zh/usage/usage-guide">使用指南</a></li><li class="footer__item"><a class="footer__link-item" href="/redux-toolkit-zh/api/configureStore">API参考</a></li><li class="footer__item"><a class="footer__link-item" href="/redux-toolkit-zh/rtk-query/overview">RTK 查询</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://stackoverflow.com/questions/tagged/redux" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/0ZcbPKXt5bZ6au5t" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/reduxjs/redux-toolkit" target="_blank" rel="noopener noreferrer" class="footer__link-item">Redux Toolkit GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/ouweiya/redux-toolkit-zh" target="_blank" rel="noopener noreferrer" class="footer__link-item">Redux Toolkit GitHub 中文<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item">
                <a href="https://www.netlify.com">
                  <img src="https://www.netlify.com/img/global/badges/netlify-light.svg" alt="Deploys by Netlify">
                </a>
              </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/redux-toolkit-zh/img/redux_white.svg" alt="Redux Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/redux-toolkit-zh/img/redux_white.svg" alt="Redux Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">版权所有 © 2015–2024 Dan Abramov 和 Redux 文档的作者。</div></div></div></footer></div>
</body>
</html>