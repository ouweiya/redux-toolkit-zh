"use strict";(self.webpackChunkredux_toolkit_zh=self.webpackChunkredux_toolkit_zh||[]).push([[1684],{4874:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var i=n(4848),r=n(8453);const o={id:"prefetching",title:"Prefetching",sidebar_label:"Prefetching",hide_title:!0,description:"RTK Query > Usage > Prefetching: fetching before user interaction"},s="Prefetching",a={id:"rtk-query/usage/prefetching",title:"Prefetching",description:"RTK Query > Usage > Prefetching: fetching before user interaction",source:"@site/docs/rtk-query/usage/prefetching.mdx",sourceDirName:"rtk-query/usage",slug:"/rtk-query/usage/prefetching",permalink:"/redux-toolkit-zh/rtk-query/usage/prefetching",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/rtk-query/usage/prefetching.mdx",tags:[],version:"current",frontMatter:{id:"prefetching",title:"Prefetching",sidebar_label:"Prefetching",hide_title:!0,description:"RTK Query > Usage > Prefetching: fetching before user interaction"},sidebar:"docs",previous:{title:"Pagination",permalink:"/redux-toolkit-zh/rtk-query/usage/pagination"},next:{title:"Polling",permalink:"/redux-toolkit-zh/rtk-query/usage/polling"}},l={},c=[{value:"Prefetching with React Hooks",id:"prefetching-with-react-hooks",level:2},{value:"Customizing the Hook Behavior",id:"customizing-the-hook-behavior",level:3},{value:"Trigger Function Behavior",id:"trigger-function-behavior",level:3},{value:"Recipe: Prefetch Immediately",id:"recipe-prefetch-immediately",level:3},{value:"Prefetching Without Hooks",id:"prefetching-without-hooks",level:2},{value:"Prefetching Examples",id:"prefetching-examples",level:2},{value:"Basic Prefetching",id:"basic-prefetching",level:3},{value:"Automatic Prefetching",id:"automatic-prefetching",level:3},{value:"Prefetching All Known Pages",id:"prefetching-all-known-pages",level:3}];function h(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.p,{children:"\xa0"}),"\n",(0,i.jsx)(t.h1,{id:"prefetching",children:"Prefetching"}),"\n",(0,i.jsxs)(t.p,{children:["The goal of prefetching is to make data fetch ",(0,i.jsx)(t.em,{children:"before"})," the user navigates to a page or attempts to load some known content."]}),"\n",(0,i.jsx)(t.p,{children:"There are a handful of situations that you may want to do this, but some very common use cases are:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"User hovers over a navigation element"}),"\n",(0,i.jsx)(t.li,{children:"User hovers over a list element that is a link"}),"\n",(0,i.jsx)(t.li,{children:"User hovers over a next pagination button"}),"\n",(0,i.jsx)(t.li,{children:"User navigates to a page and you know that some components down the tree will require said data. This way, you can prevent fetching waterfalls."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"prefetching-with-react-hooks",children:"Prefetching with React Hooks"}),"\n",(0,i.jsxs)(t.p,{children:["Similar to the ",(0,i.jsx)(t.a,{href:"./mutations",children:(0,i.jsx)(t.code,{children:"useMutation"})})," hook, the ",(0,i.jsx)(t.code,{children:"usePrefetch"}),' hook will not run automatically \u2014 it returns a "trigger function" that can be used to initiate the behavior.']}),"\n",(0,i.jsxs)(t.p,{children:["It accepts two arguments: the first is the key of a query action that you ",(0,i.jsx)(t.a,{href:"../api/createApi#endpoints",children:"defined in your API service"}),", and the second is an object of two optional parameters:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="usePrefetch Signature" no-transpile',children:"export type PrefetchOptions =\n  | { force?: boolean }\n  | {\n      ifOlderThan?: false | number;\n    };\n\nusePrefetch<EndpointName extends QueryKeys<Definitions>>(\n    endpointName: EndpointName,\n    options?: PrefetchOptions\n  ): (arg: QueryArgFrom<Definitions[EndpointName]>, options?: PrefetchOptions) => void;\n"})}),"\n",(0,i.jsx)(t.h3,{id:"customizing-the-hook-behavior",children:"Customizing the Hook Behavior"}),"\n",(0,i.jsx)(t.p,{children:"You can specify these prefetch options when declaring the hook or at the call site. The call site will take priority over the defaults."}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"ifOlderThan"})," - (default: ",(0,i.jsx)(t.code,{children:"false"})," | ",(0,i.jsx)(t.code,{children:"number"}),") - ",(0,i.jsx)(t.em,{children:"number is value in seconds"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If specified, it will only run the query if the difference between ",(0,i.jsx)(t.code,{children:"new Date()"})," and the last ",(0,i.jsx)(t.code,{children:"fulfilledTimeStamp"})," is greater than the given value"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"force"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If ",(0,i.jsx)(t.code,{children:"force: true"}),", it will ignore the ",(0,i.jsx)(t.code,{children:"ifOlderThan"})," value if it is set and the query will be run even if it exists in the cache."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"trigger-function-behavior",children:"Trigger Function Behavior"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["The trigger function ",(0,i.jsx)(t.em,{children:"always"})," returns ",(0,i.jsx)(t.code,{children:"void"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["If ",(0,i.jsx)(t.code,{children:"force: true"})," is set during the declaration or at the call site, the query will be run no matter what. The one exception to that is if the same query is already in-flight."]}),"\n",(0,i.jsx)(t.li,{children:"If no options are specified and the query exists in the cache, the query will not be performed."}),"\n",(0,i.jsxs)(t.li,{children:["If no options are specified and the query ",(0,i.jsx)(t.em,{children:"does not exist"})," in the cache, the query will be performed.","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Assuming"})," you have a ",(0,i.jsx)(t.code,{children:"useQuery"})," hook in the tree that is subscribed to the same query that you are prefetching:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"useQuery"})," will return ",(0,i.jsx)(t.code,{children:"{isLoading: true, isFetching: true, ...rest"}),"}"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["If ",(0,i.jsx)(t.code,{children:"ifOlderThan"})," is specified but evaluates to false and the query is in the cache, the query will not be performed."]}),"\n",(0,i.jsxs)(t.li,{children:["If ",(0,i.jsx)(t.code,{children:"ifOlderThan"})," is specified and evaluates to true, the query will be performed even if there is an existing cache entry.","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Assuming"})," you have a ",(0,i.jsx)(t.code,{children:"useQuery"})," hook in the tree that is subscribed to the same query that you are prefetching:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"useQuery"})," will return ",(0,i.jsx)(t.code,{children:"{isLoading: false, isFetching: true, ...rest"}),"}"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-tsx",metastring:'no-transpile title="usePrefetch Example"',children:"function User() {\n  const prefetchUser = usePrefetch('getUser')\n\n  // Low priority hover will not fire unless the last request happened more than 35s ago\n  // High priority hover will _always_ fire\n  return (\n    <div>\n      <button onMouseEnter={() => prefetchUser(4, { ifOlderThan: 35 })}>\n        Low priority\n      </button>\n      <button onMouseEnter={() => prefetchUser(4, { force: true })}>\n        High priority\n      </button>\n    </div>\n  )\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"recipe-prefetch-immediately",children:"Recipe: Prefetch Immediately"}),"\n",(0,i.jsx)(t.p,{children:"In some cases, you may want to prefetch a resource immediately. You can implement this in just a few lines of code:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="hooks/usePrefetchImmediately.ts" no-transpile',children:"type EndpointNames = keyof typeof api.endpoints\n\nexport function usePrefetchImmediately<T extends EndpointNames>(\n  endpoint: T,\n  arg: Parameters<(typeof api.endpoints)[T]['initiate']>[0],\n  options: PrefetchOptions = {},\n) {\n  const dispatch = useAppDispatch()\n  useEffect(() => {\n    dispatch(api.util.prefetch(endpoint, arg as any, options))\n  }, [])\n}\n\n// In a component\nusePrefetchImmediately('getUser', 5)\n"})}),"\n",(0,i.jsx)(t.h2,{id:"prefetching-without-hooks",children:"Prefetching Without Hooks"}),"\n",(0,i.jsxs)(t.p,{children:["If you're not using the ",(0,i.jsx)(t.code,{children:"usePrefetch"})," hook, you can recreate the same behavior on your own in any framework."]}),"\n",(0,i.jsxs)(t.p,{children:["When dispatching the ",(0,i.jsx)(t.code,{children:"prefetch"})," thunk as shown below you will see the same exact behavior as ",(0,i.jsx)(t.a,{href:"#trigger-function-behavior",children:"described here"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="Non-hook prefetching example" no-transpile',children:"store.dispatch(\n  api.util.prefetch(endpointName, arg, { force: false, ifOlderThan: 10 }),\n)\n"})}),"\n",(0,i.jsx)(t.p,{children:"You can also dispatch the query action, but you would be responsible for implementing any additional logic."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="Alternate method of manual prefetching" no-transpile',children:"dispatch(api.endpoints[endpointName].initiate(arg, { forceRefetch: true }))\n"})}),"\n",(0,i.jsx)(t.h2,{id:"prefetching-examples",children:"Prefetching Examples"}),"\n",(0,i.jsx)(t.h3,{id:"basic-prefetching",children:"Basic Prefetching"}),"\n",(0,i.jsxs)(t.p,{children:["This is a very basic example that shows how you can prefetch when a user hovers over the next arrow. This is probably not the optimal solution, because if they hover, click, then change pages without moving their mouse, we wouldn't know to prefetch the next page because we wouldn't see the next ",(0,i.jsx)(t.code,{children:"onMouseEnter"})," event. In this case, you would need to handle this on your own. You could also consider automatically prefetching the next page..."]}),"\n",(0,i.jsx)("iframe",{src:"https://codesandbox.io/embed/github/reduxjs/redux-toolkit/tree/master/examples/query/react/prefetching?fontsize=12&runonclick=1&hidenavigation=1&theme=dark",style:{width:"100%",height:"600px",border:0,borderRadius:"4px",overflow:"hidden"},title:"RTK Query - Prefetching Example",allow:"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb",sandbox:"allow-modals allow-forms allow-popups allow-scripts allow-same-origin"}),"\n",(0,i.jsx)(t.h3,{id:"automatic-prefetching",children:"Automatic Prefetching"}),"\n",(0,i.jsxs)(t.p,{children:["Picking up on our last example, we automatically ",(0,i.jsx)(t.code,{children:"prefetch"})," the next page, giving the appearance of no network delay."]}),"\n",(0,i.jsx)("iframe",{src:"https://codesandbox.io/embed/github/reduxjs/redux-toolkit/tree/master/examples/query/react/prefetching-automatic?fontsize=12&runonclick=1&hidenavigation=1&theme=dark",style:{width:"100%",height:"600px",border:0,borderRadius:"4px",overflow:"hidden"},title:"RTK Query - Automatic Prefetching Example (on hover)",allow:"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb",sandbox:"allow-modals allow-forms allow-popups allow-scripts allow-same-origin"}),"\n",(0,i.jsx)(t.h3,{id:"prefetching-all-known-pages",children:"Prefetching All Known Pages"}),"\n",(0,i.jsxs)(t.p,{children:["After the first query initialized by ",(0,i.jsx)(t.code,{children:"useQuery"})," runs, we automatically fetch all remaining pages."]}),"\n",(0,i.jsx)("iframe",{src:"https://codesandbox.io/embed/github/reduxjs/redux-toolkit/tree/master/examples/query/react/prefetching-automatic-waterfall?fontsize=12&runonclick=1&hidenavigation=1&theme=dark&module=%2Fsrc%2Ffeatures%2Fposts%2FPostsManager.tsx",style:{width:"100%",height:"600px",border:0,borderRadius:"4px",overflow:"hidden"},title:"RTK Query - Automatic Prefetching Waterfall Example",allow:"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb",sandbox:"allow-modals allow-forms allow-popups allow-scripts allow-same-origin"})]})}function d(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>a});var i=n(6540);const r={},o=i.createContext(r);function s(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);