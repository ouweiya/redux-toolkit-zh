"use strict";(self.webpackChunkredux_toolkit_zh=self.webpackChunkredux_toolkit_zh||[]).push([[2339],{3296:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var n=r(4848),s=r(8453);const a={id:"createSelector",title:"createSelector",sidebar_label:"createSelector",hide_title:!0},o="createSelector",c={id:"api/createSelector",title:"createSelector",description:"&nbsp;",source:"@site/docs/api/createSelector.mdx",sourceDirName:"api",slug:"/api/createSelector",permalink:"/redux-toolkit-zh/api/createSelector",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/api/createSelector.mdx",tags:[],version:"current",frontMatter:{id:"createSelector",title:"createSelector",sidebar_label:"createSelector",hide_title:!0},sidebar:"docs",previous:{title:"combineSlices",permalink:"/redux-toolkit-zh/api/combineSlices"},next:{title:"Matching Utilities",permalink:"/redux-toolkit-zh/api/matching-utilities"}},i={},l=[{value:"Overview",id:"overview",level:2},{value:"<code>createDraftSafeSelector</code>",id:"createdraftsafeselector",level:2},{value:"Defining a Pre-Typed <code>createDraftSelector</code>",id:"defining-a-pre-typed-createdraftselector",level:3}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"\xa0"}),"\n",(0,n.jsx)(t.h1,{id:"createselector",children:(0,n.jsx)(t.code,{children:"createSelector"})}),"\n",(0,n.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"createSelector"})," utility from the ",(0,n.jsx)(t.a,{href:"https://github.com/reduxjs/reselect",children:"Reselect library"}),", re-exported for ease of use."]}),"\n",(0,n.jsxs)(t.p,{children:["For more details on using ",(0,n.jsx)(t.code,{children:"createSelector"}),", see:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["The ",(0,n.jsx)(t.a,{href:"https://github.com/reduxjs/reselect",children:"Reselect API documentation"})]}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://react-redux.js.org/next/api/hooks#using-memoizing-selectors",children:"React-Redux docs: Hooks API - Using memoizing selectors"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://blog.isquaredsoftware.com/2017/12/idiomatic-redux-using-reselect-selectors/",children:"Idiomatic Redux: Using Reselect Selectors for Encapsulation and Performance"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/markerikson/react-redux-links/blob/master/redux-reducers-selectors.md",children:"React/Redux Links: Reducers and Selectors"})}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["Prior to v0.7, RTK re-exported ",(0,n.jsx)(t.code,{children:"createSelector"})," from ",(0,n.jsx)(t.a,{href:"https://github.com/planttheidea/selectorator",children:(0,n.jsx)(t.code,{children:"selectorator"})}),", which\nallowed using string keypaths as input selectors. This was removed, as it ultimately did not provide enough benefits, and\nthe string keypaths made static typing for selectors difficult."]})}),"\n",(0,n.jsx)(t.h2,{id:"createdraftsafeselector",children:(0,n.jsx)(t.code,{children:"createDraftSafeSelector"})}),"\n",(0,n.jsx)(t.p,{children:"In general, we recommend against using selectors inside of reducers:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Selectors typically expect the entire Redux state object as an argument, while slice reducers only have access to a specific subset of the entire Redux state"}),"\n",(0,n.jsxs)(t.li,{children:["Reselect's ",(0,n.jsx)(t.code,{children:"createSelector"})," relies on reference comparisons to determine if inputs have changed, and if an Immer Proxy-wrapped draft value is passed in to a selector, the selector may see the same reference and think nothing has changed."]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["However, some users have requested the ability to create selectors that will work correctly inside of Immer-powered reducers. One use case for this might be collecting an ordered set of items when using ",(0,n.jsx)(t.code,{children:"createEntityAdapter"}),", such as ",(0,n.jsx)(t.code,{children:"const orderedTodos = todosSelectors.selectAll(todosState)"}),", and then using ",(0,n.jsx)(t.code,{children:"orderedTodos"})," in the rest of the reducer logic."]}),"\n",(0,n.jsxs)(t.p,{children:["Besides re-exporting ",(0,n.jsx)(t.code,{children:"createSelector"}),", RTK also exports a wrapped version of ",(0,n.jsx)(t.code,{children:"createSelector"})," named ",(0,n.jsx)(t.code,{children:"createDraftSafeSelector"})," that allows you to create selectors that can safely be used inside of ",(0,n.jsx)(t.code,{children:"createReducer"})," and ",(0,n.jsx)(t.code,{children:"createSlice"})," reducers with Immer-powered mutable logic. When used with plain state values, the selector will still memoize normally based on the inputs. But, when used with Immer draft values, the selector will err on the side of recalculating the results, just to be safe."]}),"\n",(0,n.jsxs)(t.p,{children:["All selectors created by ",(0,n.jsx)(t.code,{children:"entityAdapter.getSelectors"}),' are "draft safe" selectors by default.']}),"\n",(0,n.jsx)(t.p,{children:"Example:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:"no-transpile",children:"const selectSelf = (state: State) => state\nconst unsafeSelector = createSelector(selectSelf, (state) => state.value)\nconst draftSafeSelector = createDraftSafeSelector(\n  selectSelf,\n  (state) => state.value,\n)\n\n// in your reducer:\n\nstate.value = 1\n\nconst unsafe1 = unsafeSelector(state)\nconst safe1 = draftSafeSelector(state)\n\nstate.value = 2\n\nconst unsafe2 = unsafeSelector(state)\nconst safe2 = draftSafeSelector(state)\n"})}),"\n",(0,n.jsxs)(t.p,{children:["After executing that, ",(0,n.jsx)(t.code,{children:"unsafe1"})," and ",(0,n.jsx)(t.code,{children:"unsafe2"})," will be of the same value, because the memoized selector was\nexecuted on the same object - but ",(0,n.jsx)(t.code,{children:"safe2"})," will actually be different from ",(0,n.jsx)(t.code,{children:"safe1"})," (with the updated value of ",(0,n.jsx)(t.code,{children:"2"}),"),\nbecause the safe selector detected that it was executed on a Immer draft object and recalculated using the current\nvalue instead of returning a cached value."]}),"\n",(0,n.jsxs)(t.admonition,{type:"tip",children:[(0,n.jsx)(t.mdxAdmonitionTitle,{children:(0,n.jsx)(t.code,{children:"createDraftSafeSelectorCreator"})}),(0,n.jsxs)(t.p,{children:["RTK also exports a ",(0,n.jsx)(t.code,{children:"createDraftSafeSelectorCreator"}),' function, the "draft safe" equivalent of ',(0,n.jsx)(t.a,{href:"https://github.com/reduxjs/reselect#createselectorcreatormemoize-memoizeoptions",children:(0,n.jsx)(t.code,{children:"createSelectorCreator"})}),"."]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:"no-transpile",children:"import {\n  createDraftSafeSelectorCreator,\n  weakMapMemoize,\n} from '@reduxjs/toolkit'\n\nconst createWeakMapDraftSafeSelector =\n  createDraftSafeSelectorCreator(weakMapMemoize)\n\nconst selectSelf = (state: State) => state\nconst draftSafeSelector = createWeakMapDraftSafeSelector(\n  selectSelf,\n  (state) => state.value,\n)\n"})})]}),"\n",(0,n.jsxs)(t.h3,{id:"defining-a-pre-typed-createdraftselector",children:["Defining a Pre-Typed ",(0,n.jsx)(t.code,{children:"createDraftSelector"})]}),"\n",(0,n.jsxs)(t.p,{children:['As of RTK 2.1, you can define a "pre-typed" version of ',(0,n.jsx)(t.code,{children:"createDraftSafeSelector"})," that can have the type for ",(0,n.jsx)(t.code,{children:"state"})," built in. This lets you set up those types once, so you don't have to repeat them each time you call ",(0,n.jsx)(t.code,{children:"createDraftSafeSelector"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:"no-transpile",children:"const createTypedDraftSafeSelector =\n  createDraftSafeSelector.withTypes<RootState>()\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Import and use the pre-typed ",(0,n.jsx)(t.code,{children:"createTypedDraftSafeSelector"})," function, and it will automatically know that the ",(0,n.jsx)(t.code,{children:"state"})," argument is of type ",(0,n.jsx)(t.code,{children:"RootState"}),"."]}),"\n",(0,n.jsxs)(t.admonition,{title:"Known Limitations",type:"warning",children:[(0,n.jsx)(t.p,{children:"Currently this approach only works if input selectors are provided as a single array."}),(0,n.jsx)(t.p,{children:"If you pass the input selectors as separate inline arguments, the parameter types of the result function will not be inferred. As a workaround you can either"}),(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Wrap your input selectors in a single array"}),"\n",(0,n.jsx)(t.li,{children:"You can annotate the parameter types of the result function:"}),"\n"]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:"no-transpile",children:"import { createSelector } from 'reselect'\n\ninterface Todo {\n  id: number\n  completed: boolean\n}\n\ninterface Alert {\n  id: number\n  read: boolean\n}\n\nexport interface RootState {\n  todos: Todo[]\n  alerts: Alert[]\n}\n\nexport const createTypedDraftSafeSelector =\n  createDraftSafeSelector.withTypes<RootState>()\n\nconst selectTodoIds = createTypedDraftSafeSelector(\n  // Type of `state` is set to `RootState`, no need to manually set the type\n  (state) => state.todos,\n  // \u274c Known limitation: Parameter types are not inferred in this scenario\n  // so you will have to manually annotate them.\n  (todos: Todo[]) => todos.map(({ id }) => id),\n)\n"})})]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>c});var n=r(6540);const s={},a=n.createContext(s);function o(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);