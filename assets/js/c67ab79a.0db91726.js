"use strict";(self.webpackChunkredux_toolkit_zh=self.webpackChunkredux_toolkit_zh||[]).push([[5399],{7002:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var s=r(4848),t=r(8453);const a={id:"customizing-queries",title:"\u81ea\u5b9a\u4e49\u67e5\u8be2",sidebar_label:"\u81ea\u5b9a\u4e49\u67e5\u8be2",hide_title:!0,description:"RTK Query > Usage > Customizing Queries: overriding default query behavior"},i="\u81ea\u5b9a\u4e49\u67e5\u8be2",o={id:"rtk-query/usage/customizing-queries",title:"\u81ea\u5b9a\u4e49\u67e5\u8be2",description:"RTK Query > Usage > Customizing Queries: overriding default query behavior",source:"@site/docs/rtk-query/usage/customizing-queries.mdx",sourceDirName:"rtk-query/usage",slug:"/rtk-query/usage/customizing-queries",permalink:"/redux-toolkit-zh/rtk-query/usage/customizing-queries",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/rtk-query/usage/customizing-queries.mdx",tags:[],version:"current",frontMatter:{id:"customizing-queries",title:"\u81ea\u5b9a\u4e49\u67e5\u8be2",sidebar_label:"\u81ea\u5b9a\u4e49\u67e5\u8be2",hide_title:!0,description:"RTK Query > Usage > Customizing Queries: overriding default query behavior"},sidebar:"docs",previous:{title:"\u81ea\u5b9a\u4e49 createApi",permalink:"/redux-toolkit-zh/rtk-query/usage/customizing-create-api"},next:{title:"\u4e0d\u4f7f\u7528 React Hooks \u7684\u7528\u6cd5",permalink:"/redux-toolkit-zh/rtk-query/usage/usage-without-react-hooks"}},d={},l=[{value:"\u4f7f\u7528 <code>baseQuery</code> \u81ea\u5b9a\u4e49\u67e5\u8be2",id:"\u4f7f\u7528-basequery-\u81ea\u5b9a\u4e49\u67e5\u8be2",level:2},{value:"\u5b9e\u73b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684 <code>baseQuery</code>",id:"\u5b9e\u73b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684-basequery",level:3},{value:"baseQuery \u51fd\u6570\u53c2\u6570",id:"basequery-\u51fd\u6570\u53c2\u6570",level:4},{value:"baseQuery \u51fd\u6570\u8fd4\u56de\u503c",id:"basequery-\u51fd\u6570\u8fd4\u56de\u503c",level:4},{value:"fetchBaseQuery \u9ed8\u8ba4\u503c",id:"fetchbasequery-\u9ed8\u8ba4\u503c",level:4},{value:"\u4f7f\u7528 <code>transformResponse</code> \u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",id:"\u4f7f\u7528-transformresponse-\u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",level:2},{value:"\u4f7f\u7528 <code>transformErrorResponse</code> \u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",id:"\u4f7f\u7528-transformerrorresponse-\u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",level:2},{value:"\u4f7f\u7528 <code>queryFn</code> \u81ea\u5b9a\u4e49\u67e5\u8be2",id:"\u4f7f\u7528-queryfn-\u81ea\u5b9a\u4e49\u67e5\u8be2",level:2},{value:"\u5b9e\u73b0\u4e00\u4e2a <code>queryFn</code>",id:"\u5b9e\u73b0\u4e00\u4e2a-queryfn",level:3},{value:"\u57fa\u7840 <code>queryFn</code> \u793a\u4f8b",id:"\u57fa\u7840-queryfn-\u793a\u4f8b",level:4},{value:"queryFn \u51fd\u6570\u53c2\u6570",id:"queryfn-\u51fd\u6570\u53c2\u6570",level:4},{value:"queryFn \u51fd\u6570\u8fd4\u56de\u503c",id:"queryfn-\u51fd\u6570\u8fd4\u56de\u503c",level:4},{value:"\u793a\u4f8b - <code>baseQuery</code>",id:"\u793a\u4f8b---basequery",level:2},{value:"Axios baseQuery",id:"axios-basequery",level:3},{value:"GraphQL baseQuery",id:"graphql-basequery",level:3},{value:"\u901a\u8fc7\u6269\u5c55fetchBaseQuery\u81ea\u52a8\u91cd\u65b0\u6388\u6743",id:"\u901a\u8fc7\u6269\u5c55fetchbasequery\u81ea\u52a8\u91cd\u65b0\u6388\u6743",level:3},{value:"\u9632\u6b62\u591a\u4e2a\u672a\u6388\u6743\u9519\u8bef",id:"\u9632\u6b62\u591a\u4e2a\u672a\u6388\u6743\u9519\u8bef",level:4},{value:"\u81ea\u52a8\u91cd\u8bd5",id:"\u81ea\u52a8\u91cd\u8bd5",level:3},{value:"\u9000\u51fa\u9519\u8bef\u91cd\u8bd5",id:"\u9000\u51fa\u9519\u8bef\u91cd\u8bd5",level:4},{value:"\u5411\u67e5\u8be2\u6dfb\u52a0\u5143\u4fe1\u606f",id:"\u5411\u67e5\u8be2\u6dfb\u52a0\u5143\u4fe1\u606f",level:3},{value:"\u4f7f\u7528 Redux \u72b6\u6001\u6784\u9020\u52a8\u6001\u57fa\u7840 URL",id:"\u4f7f\u7528-redux-\u72b6\u6001\u6784\u9020\u52a8\u6001\u57fa\u7840-url",level:3},{value:"\u793a\u4f8b - <code>transformResponse</code>",id:"\u793a\u4f8b---transformresponse",level:2},{value:"\u89e3\u5305\u6df1\u5ea6\u5d4c\u5957\u7684 GraphQL \u6570\u636e",id:"\u89e3\u5305\u6df1\u5ea6\u5d4c\u5957\u7684-graphql-\u6570\u636e",level:3},{value:"\u4f7f\u7528 <code>createEntityAdapter</code> \u6807\u51c6\u5316\u6570\u636e",id:"\u4f7f\u7528-createentityadapter-\u6807\u51c6\u5316\u6570\u636e",level:3},{value:"\u793a\u4f8b - <code>queryFn</code>",id:"\u793a\u4f8b---queryfn",level:2},{value:"\u4f7f\u7528\u7b2c\u4e09\u65b9 SDK",id:"\u4f7f\u7528\u7b2c\u4e09\u65b9-sdk",level:3},{value:"\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684 queryFn",id:"\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684-queryfn",level:3},{value:"\u65e0\u521d\u59cb\u8bf7\u6c42\u7684\u6570\u636e\u6d41",id:"\u65e0\u521d\u59cb\u8bf7\u6c42\u7684\u6570\u636e\u6d41",level:3},{value:"\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42",id:"\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"\xa0"}),"\n",(0,s.jsx)(n.h1,{id:"\u81ea\u5b9a\u4e49\u67e5\u8be2",children:"\u81ea\u5b9a\u4e49\u67e5\u8be2"}),"\n",(0,s.jsx)(n.p,{children:"RTK Query \u5bf9\u4e8e\u4f60\u7684\u8bf7\u6c42\u5982\u4f55\u89e3\u6790\u5e76\u4e0d\u5173\u5fc3\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u4f60\u559c\u6b22\u7684\u5e93\u6765\u5904\u7406\u8bf7\u6c42\uff0c\u6216\u8005\u5b8c\u5168\u4e0d\u4f7f\u7528\u5e93\u3002RTK Query \u63d0\u4f9b\u4e86\u9884\u671f\u80fd\u8986\u76d6\u5927\u591a\u6570\u7528\u4f8b\u7684\u5408\u7406\u9ed8\u8ba4\u503c\uff0c\u540c\u65f6\u4e5f\u5141\u8bb8\u81ea\u5b9a\u4e49\u4ee5\u6539\u53d8\u67e5\u8be2\u5904\u7406\u4ee5\u9002\u5e94\u7279\u5b9a\u9700\u6c42\u3002"}),"\n",(0,s.jsxs)(n.h2,{id:"\u4f7f\u7528-basequery-\u81ea\u5b9a\u4e49\u67e5\u8be2",children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u81ea\u5b9a\u4e49\u67e5\u8be2"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5904\u7406\u67e5\u8be2\u7684\u9ed8\u8ba4\u65b9\u6cd5\u662f\u901a\u8fc7 ",(0,s.jsx)(n.a,{href:"../api/createApi",children:(0,s.jsx)(n.code,{children:"createApi"})})," \u7684 ",(0,s.jsx)(n.a,{href:"../api/createApi#basequery",children:(0,s.jsx)(n.code,{children:"baseQuery"})})," \u9009\u9879\uff0c\u7ed3\u5408\u7aef\u70b9\u5b9a\u4e49\u7684 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#query",children:(0,s.jsx)(n.code,{children:"query"})})," \u9009\u9879\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4e3a\u4e86\u5904\u7406\u67e5\u8be2\uff0c\u7aef\u70b9\u88ab\u5b9a\u4e49\u4e3a\u4e00\u4e2a ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#query",children:(0,s.jsx)(n.code,{children:"query"})})," \u9009\u9879\uff0c\u5b83\u5c06\u5176\u8fd4\u56de\u503c\u4f20\u9012\u7ed9\u7528\u4e8e API \u7684\u901a\u7528 ",(0,s.jsx)(n.a,{href:"../api/createApi#basequery",children:(0,s.jsx)(n.code,{children:"baseQuery"})})," \u51fd\u6570\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cRTK Query \u9644\u5e26\u4e86 ",(0,s.jsx)(n.a,{href:"../api/fetchBaseQuery",children:(0,s.jsx)(n.code,{children:"fetchBaseQuery"})}),"\uff0c\u8fd9\u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 ",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API",children:(0,s.jsx)(n.code,{children:"fetch"})})," \u5305\u88c5\u5668\uff0c\u5b83\u81ea\u52a8\u5904\u7406\u8bf7\u6c42\u5934\u548c\u54cd\u5e94\u89e3\u6790\uff0c\u7c7b\u4f3c\u4e8e\u5e38\u89c1\u7684\u5e93\u5982 ",(0,s.jsx)(n.code,{children:"axios"}),"\u3002\u5982\u679c ",(0,s.jsx)(n.code,{children:"fetchBaseQuery"})," \u672c\u8eab\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u9700\u6c42\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u5305\u88c5\u51fd\u6570\u6765\u81ea\u5b9a\u4e49\u5176\u884c\u4e3a\uff0c\u6216\u8005\u4e3a ",(0,s.jsx)(n.a,{href:"../api/createApi",children:(0,s.jsx)(n.code,{children:"createApi"})})," \u4f7f\u7528\u4ece\u5934\u5f00\u59cb\u521b\u5efa\u4f60\u81ea\u5df1\u7684 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#basequery",children:(0,s.jsx)(n.code,{children:"baseQuery"})})," \u51fd\u6570\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u53c2\u89c1 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#basequery",children:(0,s.jsx)(n.code,{children:"baseQuery API Reference"})}),"\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"\u5b9e\u73b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684-basequery",children:["\u5b9e\u73b0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"})]}),"\n",(0,s.jsxs)(n.p,{children:["RTK Query \u671f\u671b ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u51fd\u6570\u88ab\u8c03\u7528\u65f6\u5e26\u6709\u4e09\u4e2a\u53c2\u6570\uff1a",(0,s.jsx)(n.code,{children:"args"}),"\uff0c",(0,s.jsx)(n.code,{children:"api"})," \u548c ",(0,s.jsx)(n.code,{children:"extraOptions"}),"\u3002\u5b83\u5e94\u8be5\u8fd4\u56de\u4e00\u4e2a\u5e26\u6709 ",(0,s.jsx)(n.code,{children:"data"})," \u6216 ",(0,s.jsx)(n.code,{children:"error"})," \u5c5e\u6027\u7684\u5bf9\u8c61\uff0c\u6216\u8005\u4e00\u4e2a\u89e3\u6790\u4e3a\u8fd4\u56de\u6b64\u7c7b\u5bf9\u8c61\u7684 promise\u3002"]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsxs)(n.p,{children:["\u57fa\u7840\u67e5\u8be2\u548c\u67e5\u8be2\u51fd\u6570\u5fc5\u987b ",(0,s.jsx)(n.em,{children:"\u59cb\u7ec8"})," \u81ea\u5df1\u6355\u83b7\u9519\u8bef\uff0c\u5e76\u5728\u5bf9\u8c61\u4e2d\u8fd4\u56de\u5b83\uff01"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"no-transpile",children:"function brokenCustomBaseQuery() {\n  // \u274c \u4e0d\u8981\u8ba9\u8fd9\u4e2a\u81ea\u5df1\u629b\u51fa\n  const data = await fetchSomeData()\n  return { data }\n}\n\nfunction correctCustomBaseQuery() {\n  // \u2705 \u6355\u83b7\u9519\u8bef\u5e76 _\u8fd4\u56de_ \u5b83\u4eec\uff0c\u4ee5\u4fbf RTKQ \u903b\u8f91\u53ef\u4ee5\u8ddf\u8e2a\u5b83\n  try {\n    const data = await fetchSomeData()\n    return { data }\n  } catch (error) {\n    return { error }\n  }\n}\n"})})]}),"\n",(0,s.jsx)(n.h4,{id:"basequery-\u51fd\u6570\u53c2\u6570",children:"baseQuery \u51fd\u6570\u53c2\u6570"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="baseQuery \u793a\u4f8b\u53c2\u6570" no-transpile',children:"const customBaseQuery = (\n  // highlight-start\n  args,\n  { signal, dispatch, getState },\n  extraOptions,\n  // highlight-end\n) => {\n  // \u7701\u7565\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"basequery-\u51fd\u6570\u8fd4\u56de\u503c",children:"baseQuery \u51fd\u6570\u8fd4\u56de\u503c"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u6210\u529f\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { data: YourData }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u9519\u8bef\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { error: YourError }\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="baseQuery \u793a\u4f8b\u8fd4\u56de\u503c" no-transpile',children:"const customBaseQuery = (\n  args,\n  { signal, dispatch, getState },\n  extraOptions,\n) => {\n  // highlight-start\n  if (Math.random() > 0.5) return { error: 'Too high!' }\n  return { data: 'All good!' }\n  // highlight-end\n}\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"\u8fd9\u79cd\u683c\u5f0f\u662f\u5fc5\u9700\u7684\uff0c\u4ee5\u4fbf RTK Query \u53ef\u4ee5\u63a8\u65ad\u4f60\u7684\u54cd\u5e94\u7684\u8fd4\u56de\u7c7b\u578b\u3002"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u5176\u6838\u5fc3\uff0c\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u51fd\u6570\u53ea\u9700\u8981\u6709\u6700\u5c0f\u7684\u8fd4\u56de\u503c\u624d\u80fd\u6709\u6548\uff1b\u4e00\u4e2a\u5e26\u6709 ",(0,s.jsx)(n.code,{children:"data"})," \u6216 ",(0,s.jsx)(n.code,{children:"error"})," \u5c5e\u6027\u7684\u5bf9\u8c61\u3002\u7531\u7528\u6237\u51b3\u5b9a\u5982\u4f55\u4f7f\u7528\u63d0\u4f9b\u7684\u53c2\u6570\uff0c\u4ee5\u53ca\u5728\u51fd\u6570\u5185\u90e8\u5982\u4f55\u5904\u7406\u8bf7\u6c42\u3002"]}),"\n",(0,s.jsx)(n.h4,{id:"fetchbasequery-\u9ed8\u8ba4\u503c",children:"fetchBaseQuery \u9ed8\u8ba4\u503c"}),"\n",(0,s.jsxs)(n.p,{children:["\u5bf9\u4e8e ",(0,s.jsx)(n.a,{href:"../api/fetchBaseQuery",children:(0,s.jsx)(n.code,{children:"fetchBaseQuery"})})," \u7279\u522b\u5730\uff0c\u8fd4\u56de\u7c7b\u578b\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="fetchBaseQuery \u7684\u8fd4\u56de\u7c7b\u578b" no-transpile',children:"Promise<\n  | {\n      data: any\n      error?: undefined\n      meta?: { request: Request; response: Response }\n    }\n  | {\n      error: {\n        status: number\n        data: any\n      }\n      data?: undefined\n      meta?: { request: Request; response: Response }\n    }\n>\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u4f7f\u7528 fetchBaseQuery \u7684\u9884\u671f\u6210\u529f\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { data: YourData }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u4f7f\u7528 fetchBaseQuery \u7684\u9884\u671f\u9519\u8bef\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { error: { status: number, data: YourErrorData } }\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"\u4f7f\u7528-transformresponse-\u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"transformResponse"})," \u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi",children:(0,s.jsx)(n.code,{children:"createApi"})}),"\u4e0a\u7684\u5355\u4e2a\u7aef\u70b9\u63a5\u53d7\u4e00\u4e2a",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi",children:(0,s.jsx)(n.code,{children:"transformResponse"})}),"\u5c5e\u6027\uff0c\u8be5\u5c5e\u6027\u5141\u8bb8\u5728\u6570\u636e\u7531\u67e5\u8be2\u6216\u7a81\u53d8\u8fd4\u56de\u5e76\u547d\u4e2d\u7f13\u5b58\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformResponse"})," \u4f1a\u5728\u6210\u529f\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u4e3a\u76f8\u5e94\u7aef\u70b9\u8fd4\u56de\u6570\u636e\u65f6\u88ab\u8c03\u7528\uff0c",(0,s.jsx)(n.code,{children:"transformResponse"})," \u7684\u8fd4\u56de\u503c\u5c06\u88ab\u7528\u4f5c\u4e0e\u8be5\u7aef\u70b9\u8c03\u7528\u76f8\u5173\u8054\u7684\u7f13\u5b58\u6570\u636e\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1\u5668\u7684\u6709\u6548\u8f7d\u8377\u5c06\u76f4\u63a5\u8fd4\u56de\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function defaultTransformResponse(\n  baseQueryReturnValue: unknown,\n  meta: unknown,\n  arg: unknown,\n) {\n  return baseQueryReturnValue\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8981\u66f4\u6539\u5b83\uff0c\u63d0\u4f9b\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u51fd\u6570\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u89e3\u5305\u4e00\u4e2a\u6df1\u5ea6\u5d4c\u5957\u7684\u96c6\u5408" no-transpile',children:"transformResponse: (response, meta, arg) =>\n  response.some.deeply.nested.collection\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformResponse"})," \u4f1a\u5728 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u8fd4\u56de\u7684 ",(0,s.jsx)(n.code,{children:"meta"})," \u5c5e\u6027\u4f5c\u4e3a\u5176\u7b2c\u4e8c\u4e2a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u8fd9\u53ef\u4ee5\u5728\u786e\u5b9a\u8f6c\u6362\u54cd\u5e94\u65f6\u4f7f\u7528\u3002",(0,s.jsx)(n.code,{children:"meta"})," \u7684\u503c\u53d6\u51b3\u4e8e\u4f7f\u7528\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="transformResponse meta \u793a\u4f8b" no-transpile',children:"transformResponse: (response: { sideA: Tracks; sideB: Tracks }, meta, arg) => {\n  if (meta?.coinFlip === 'heads') {\n    return response.sideA\n  }\n  return response.sideB\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformResponse"})," \u4f1a\u5728 ",(0,s.jsx)(n.code,{children:"arg"})," \u5c5e\u6027\u63d0\u4f9b\u7ed9\u7aef\u70b9\u4f5c\u4e3a\u5176\u7b2c\u4e09\u4e2a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u8fd9\u53ef\u4ee5\u5728\u786e\u5b9a\u8f6c\u6362\u54cd\u5e94\u65f6\u4f7f\u7528\u3002",(0,s.jsx)(n.code,{children:"arg"})," \u7684\u503c\u53d6\u51b3\u4e8e\u4f7f\u7528\u7684 ",(0,s.jsx)(n.code,{children:"endpoint"}),"\uff0c\u4ee5\u53ca\u8c03\u7528\u67e5\u8be2/\u7a81\u53d8\u65f6\u4f7f\u7528\u7684\u53c2\u6570\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="transformResponse arg \u793a\u4f8b" no-transpile',children:"transformResponse: (response: Posts, meta, arg) => {\n  return {\n    originalArg: arg,\n    data: response,\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u867d\u7136\u4f7f\u7528 RTK Query \u7ba1\u7406\u7f13\u5b58\u6570\u636e\u65f6\uff0c\u5c06\u54cd\u5e94\u5b58\u50a8\u5728 ",(0,s.jsx)(n.a,{href:"https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape",children:"\u6807\u51c6\u5316\u67e5\u627e\u8868"})," \u4e2d\u7684\u9700\u6c42\u8f83\u5c11\uff0c\u4f46\u5982\u679c\u9700\u8981\uff0c\u53ef\u4ee5\u5229\u7528 ",(0,s.jsx)(n.code,{children:"transformResponse"})," \u6765\u5b9e\u73b0\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u6807\u51c6\u5316\u54cd\u5e94\u6570\u636e" no-transpile',children:"transformResponse: (response) =>\n  response.reduce((acc, curr) => {\n    acc[curr.id] = curr\n    return acc\n  }, {})\n\n/*\n  \u5c06\u4f1a\u8f6c\u6362\uff1a\n  [\n    {id: 1, name: 'Harry'},\n    {id: 2, name: 'Ron'},\n    {id: 3, name: 'Hermione'},\n  ]\n\n  \u4e3a\uff1a\n  {\n    1: { id: 1, name: \"Harry\" },\n    2: { id: 2, name: \"Ron\" },\n    3: { id: 3, name: \"Hermione\" },\n  }\n*/\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/api/createEntityAdapter",children:(0,s.jsx)(n.code,{children:"createEntityAdapter"})})," \u4e5f\u53ef\u4ee5\u4e0e ",(0,s.jsx)(n.code,{children:"transformResponse"})," \u4e00\u8d77\u4f7f\u7528\u6765\u6807\u51c6\u5316\u6570\u636e\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u5229\u7528 ",(0,s.jsx)(n.code,{children:"createEntityAdapter"})," \u63d0\u4f9b\u7684\u5176\u4ed6\u529f\u80fd\uff0c\u5305\u62ec\u63d0\u4f9b\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"ids"})," \u6570\u7ec4\uff0c\u4f7f\u7528 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/api/createEntityAdapter#sortcomparer",children:(0,s.jsx)(n.code,{children:"sortComparer"})})," \u6765\u7ef4\u62a4\u4e00\u4e2a\u59cb\u7ec8\u6392\u5e8f\u7684\u5217\u8868\uff0c\u4ee5\u53ca\u7ef4\u62a4\u5f3a\u5927\u7684 TypeScript \u652f\u6301\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u53e6\u8bf7\u53c2\u89c1 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/usage/streaming-updates#websocket-chat-api-with-a-transformed-response-shape",children:"\u5177\u6709\u8f6c\u6362\u54cd\u5e94\u5f62\u72b6\u7684 Websocket \u804a\u5929 API"}),"\uff0c\u8be5\u793a\u4f8b\u5c55\u793a\u4e86 ",(0,s.jsx)(n.code,{children:"transformResponse"})," \u5982\u4f55\u4e0e ",(0,s.jsx)(n.code,{children:"createEntityAdapter"})," \u7ed3\u5408\u4f7f\u7528\u6765\u6807\u51c6\u5316\u54cd\u5e94\u6570\u636e\uff0c\u540c\u65f6\u8fd8\u4f7f\u7528 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/usage/streaming-updates",children:(0,s.jsx)(n.code,{children:"streaming updates"})})," \u66f4\u65b0\u66f4\u591a\u6570\u636e\u3002"]}),"\n",(0,s.jsxs)(n.h2,{id:"\u4f7f\u7528-transformerrorresponse-\u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94",children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"transformErrorResponse"})," \u81ea\u5b9a\u4e49\u67e5\u8be2\u54cd\u5e94"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi",children:(0,s.jsx)(n.code,{children:"createApi"})}),"\u4e0a\u7684\u5355\u4e2a\u7aef\u70b9\u63a5\u53d7\u4e00\u4e2a",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi",children:(0,s.jsx)(n.code,{children:"transformErrorResponse"})}),"\u5c5e\u6027\uff0c\u8be5\u5c5e\u6027\u5141\u8bb8\u5728\u67e5\u8be2\u6216\u7a81\u53d8\u8fd4\u56de\u9519\u8bef\u5e76\u547d\u4e2d\u7f13\u5b58\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformErrorResponse"})," \u4f1a\u5728\u5931\u8d25\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u4e3a\u76f8\u5e94\u7aef\u70b9\u8fd4\u56de\u9519\u8bef\u65f6\u88ab\u8c03\u7528\uff0c",(0,s.jsx)(n.code,{children:"transformErrorResponse"})," \u7684\u8fd4\u56de\u503c\u5c06\u88ab\u7528\u4f5c\u4e0e\u8be5\u7aef\u70b9\u8c03\u7528\u76f8\u5173\u8054\u7684\u7f13\u5b58\u9519\u8bef\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u670d\u52a1\u5668\u7684\u6709\u6548\u8f7d\u8377\u5c06\u76f4\u63a5\u8fd4\u56de\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function defaultTransformResponse(\n  baseQueryReturnValue: unknown,\n  meta: unknown,\n  arg: unknown,\n) {\n  return baseQueryReturnValue\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8981\u66f4\u6539\u5b83\uff0c\u63d0\u4f9b\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u51fd\u6570\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u89e3\u5305\u4e00\u4e2a\u6df1\u5ea6\u5d4c\u5957\u7684\u9519\u8bef\u5bf9\u8c61" no-transpile',children:"transformErrorResponse: (response, meta, arg) =>\n  response.data.some.deeply.nested.errorObject\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformErrorResponse"})," \u4f1a\u5728 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u8fd4\u56de\u7684 ",(0,s.jsx)(n.code,{children:"meta"})," \u5c5e\u6027\u4f5c\u4e3a\u5176\u7b2c\u4e8c\u4e2a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u8fd9\u53ef\u4ee5\u5728\u786e\u5b9a\u8f6c\u6362\u54cd\u5e94\u65f6\u4f7f\u7528\u3002",(0,s.jsx)(n.code,{children:"meta"})," \u7684\u503c\u53d6\u51b3\u4e8e\u4f7f\u7528\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="transformErrorResponse meta \u793a\u4f8b" no-transpile',children:"transformErrorResponse: (\n  response: { data: { sideA: Tracks; sideB: Tracks } },\n  meta,\n  arg,\n) => {\n  if (meta?.coinFlip === 'heads') {\n    return response.data.sideA\n  }\n  return response.data.sideB\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"transformErrorResponse"})," \u4f1a\u5728 ",(0,s.jsx)(n.code,{children:"arg"})," \u5c5e\u6027\u63d0\u4f9b\u7ed9\u7aef\u70b9\u4f5c\u4e3a\u5176\u7b2c\u4e09\u4e2a\u53c2\u6570\u88ab\u8c03\u7528\uff0c\u8fd9\u53ef\u4ee5\u5728\u786e\u5b9a\u8f6c\u6362\u54cd\u5e94\u65f6\u4f7f\u7528\u3002",(0,s.jsx)(n.code,{children:"arg"})," \u7684\u503c\u53d6\u51b3\u4e8e\u4f7f\u7528\u7684 ",(0,s.jsx)(n.code,{children:"endpoint"}),"\uff0c\u4ee5\u53ca\u8c03\u7528\u67e5\u8be2/\u7a81\u53d8\u65f6\u4f7f\u7528\u7684\u53c2\u6570\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="transformErrorResponse arg \u793a\u4f8b" no-transpile',children:"transformErrorResponse: (response: Posts, meta, arg) => {\n  return {\n    originalArg: arg,\n    error: response,\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"\u4f7f\u7528-queryfn-\u81ea\u5b9a\u4e49\u67e5\u8be2",children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"queryFn"})," \u81ea\u5b9a\u4e49\u67e5\u8be2"]}),"\n",(0,s.jsxs)(n.p,{children:["RTK Query \u9ed8\u8ba4\u63d0\u4f9b\u4e86 ",(0,s.jsx)(n.code,{children:"fetchBaseQuery"}),"\uff0c\u4f7f\u5f97\u5b9a\u4e49\u4e0e HTTP URL\uff08\u5982\u5178\u578b\u7684 REST API\uff09\u901a\u4fe1\u7684\u7aef\u70b9\u53d8\u5f97\u7b80\u5355\u3002\u6211\u4eec\u4e5f\u6709\u4e0e GraphQL \u7684\u96c6\u6210\u3002\u7136\u800c\uff0cRTK Query \u7684\u6838\u5fc3\u5b9e\u9645\u4e0a\u662f\u8ddf\u8e2a ",(0,s.jsx)(n.em,{children:"\u4efb\u4f55"})," \u5f02\u6b65\u8bf7\u6c42/\u54cd\u5e94\u5e8f\u5217\u7684\u52a0\u8f7d\u72b6\u6001\u548c\u7f13\u5b58\u503c\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f HTTP \u8bf7\u6c42\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["RTK Query \u652f\u6301\u5b9a\u4e49\u8fd0\u884c\u4efb\u610f\u5f02\u6b65\u903b\u8f91\u5e76\u8fd4\u56de\u7ed3\u679c\u7684\u7aef\u70b9\u3002",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi",children:(0,s.jsx)(n.code,{children:"createApi"})})," \u4e0a\u7684\u5355\u4e2a\u7aef\u70b9\u63a5\u53d7\u4e00\u4e2a ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#queryfn",children:(0,s.jsx)(n.code,{children:"queryFn"})})," \u5c5e\u6027\uff0c\u8ba9\u4f60\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684\u5f02\u6b65\u51fd\u6570\uff0c\u5e76\u5728\u5176\u4e2d\u6dfb\u52a0\u4efb\u4f55\u4f60\u60f3\u8981\u7684\u903b\u8f91\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u5728\u4f60\u60f3\u8981\u4e3a\u5355\u4e2a\u7aef\u70b9\u6709\u7279\u522b\u4e0d\u540c\u7684\u884c\u4e3a\uff0c\u6216\u8005\u67e5\u8be2\u672c\u8eab\u4e0d\u76f8\u5173\u7684\u573a\u666f\u4e2d\u53ef\u80fd\u5f88\u6709\u7528\uff0c\u5305\u62ec\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528\u4e0d\u540c\u57fa\u7840 URL \u7684\u4e00\u6b21\u6027\u67e5\u8be2"}),"\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528\u4e0d\u540c\u8bf7\u6c42\u5904\u7406\u7684\u4e00\u6b21\u6027\u67e5\u8be2\uff0c\u5982\u81ea\u52a8\u91cd\u8bd5"}),"\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528\u4e0d\u540c\u9519\u8bef\u5904\u7406\u884c\u4e3a\u7684\u4e00\u6b21\u6027\u67e5\u8be2"}),"\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528\u7b2c\u4e09\u65b9\u5e93 SDK\uff08\u5982 Firebase \u6216 Supabase\uff09\u8fdb\u884c\u8bf7\u6c42\u7684\u67e5\u8be2"}),"\n",(0,s.jsx)(n.li,{children:"\u6267\u884c\u975e\u5178\u578b\u8bf7\u6c42/\u54cd\u5e94\u7684\u5f02\u6b65\u4efb\u52a1\u7684\u67e5\u8be2"}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42\uff08",(0,s.jsx)(n.a,{href:"#performing-multiple-requests-with-a-single-query",children:"\u793a\u4f8b"}),"\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5229\u7528\u65e0\u5173\u8054\u67e5\u8be2\u7684\u5931\u6548\u884c\u4e3a\uff08",(0,s.jsx)(n.a,{href:"#using-a-no-op-queryfn",children:"\u793a\u4f8b"}),"\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528\u65e0\u521d\u59cb\u8bf7\u6c42\u7684",(0,s.jsx)(n.a,{href:"./streaming-updates",children:"\u6d41\u5f0f\u66f4\u65b0"}),"\uff08",(0,s.jsx)(n.a,{href:"#streaming-data-with-no-initial-request",children:"\u793a\u4f8b"}),"\uff09"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4e5f\u53ef\u4ee5\u53c2\u8003 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#queryfn",children:(0,s.jsx)(n.code,{children:"queryFn API Reference"})})," \u4e86\u89e3\u7c7b\u578b\u7b7e\u540d\u548c\u53ef\u7528\u9009\u9879\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"\u5b9e\u73b0\u4e00\u4e2a-queryfn",children:["\u5b9e\u73b0\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"queryFn"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"queryFn"})," \u53ef\u4ee5\u88ab\u89c6\u4e3a\u4e00\u4e2a\u5185\u8054\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\u3002\u5b83\u5c06\u88ab\u8c03\u7528\u4e0e ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u76f8\u540c\u7684\u53c2\u6570\uff0c\u4ee5\u53ca\u63d0\u4f9b\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u51fd\u6570\u672c\u8eab\uff08",(0,s.jsx)(n.code,{children:"arg"}),"\uff0c",(0,s.jsx)(n.code,{children:"api"}),"\uff0c",(0,s.jsx)(n.code,{children:"extraOptions"})," \u548c ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\uff09\u3002\u7c7b\u4f3c\u4e8e ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\uff0c\u5b83\u9884\u671f\u8fd4\u56de\u4e00\u4e2a\u5177\u6709 ",(0,s.jsx)(n.code,{children:"data"})," \u6216 ",(0,s.jsx)(n.code,{children:"error"})," \u5c5e\u6027\u7684\u5bf9\u8c61\uff0c\u6216\u8005\u4e00\u4e2a\u89e3\u6790\u4e3a\u8fd4\u56de\u6b64\u7c7b\u5bf9\u8c61\u7684 promise\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"\u57fa\u7840-queryfn-\u793a\u4f8b",children:["\u57fa\u7840 ",(0,s.jsx)(n.code,{children:"queryFn"})," \u793a\u4f8b"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u57fa\u7840 queryFn \u793a\u4f8b" no-transpile',children:"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport { userAPI, User } from './userAPI'\n\nconst api = createApi({\n  baseQuery: fetchBaseQuery({ url: '/' }),\n  endpoints: (build) => ({\n    // \u4f7f\u7528 fetchBaseQuery \u7684\u6b63\u5e38 HTTP \u7aef\u70b9\n    getPosts: build.query<PostsResponse, void>({\n      query: () => ({ url: 'posts' }),\n    }),\n    // highlight-start\n    // \u5177\u6709\u81ea\u5b9a\u4e49 `queryFn` \u548c\u5355\u72ec\u5f02\u6b65\u903b\u8f91\u7684\u7aef\u70b9\n    getUser: build.query<User, string>({\n      queryFn: async (userId: string) => {\n        try {\n          const user = await userApi.getUserById(userId)\n          // \u5728\u4e00\u4e2a\u5e26\u6709 `data` \u5b57\u6bb5\u7684\u5bf9\u8c61\u4e2d\u8fd4\u56de\u7ed3\u679c\n          return { data: user }\n        } catch (error) {\n          // \u6355\u83b7\u4efb\u4f55\u9519\u8bef\u5e76\u5c06\u5b83\u4eec\u4f5c\u4e3a\u5e26\u6709 `error` \u5b57\u6bb5\u7684\u5bf9\u8c61\u8fd4\u56de\n          return { error }\n        }\n      },\n    }),\n    // highlight-end\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.h4,{id:"queryfn-\u51fd\u6570\u53c2\u6570",children:"queryFn \u51fd\u6570\u53c2\u6570"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="queryFn \u793a\u4f8b\u53c2\u6570" no-transpile',children:"const queryFn = (\n  // highlight-start\n  args,\n  { signal, dispatch, getState },\n  extraOptions,\n  baseQuery,\n  // highlight-end\n) => {\n  // \u7701\u7565\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"queryfn-\u51fd\u6570\u8fd4\u56de\u503c",children:"queryFn \u51fd\u6570\u8fd4\u56de\u503c"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u6210\u529f\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { data: YourData }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u9519\u8bef\u7ed3\u679c\u683c\u5f0f" no-transpile',children:"return { error: YourError }\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="queryFn \u793a\u4f8b\u8fd4\u56de\u503c" no-transpile',children:"const queryFn = (\n  args,\n  { signal, dispatch, getState },\n  extraOptions,\n  baseQuery,\n) => {\n  // highlight-start\n  if (Math.random() > 0.5) return { error: 'Too high!' }\n  return { data: 'All good!' }\n  // highlight-end\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"\u793a\u4f8b---basequery",children:["\u793a\u4f8b - ",(0,s.jsx)(n.code,{children:"baseQuery"})]}),"\n",(0,s.jsx)(n.h3,{id:"axios-basequery",children:"Axios baseQuery"}),"\n",(0,s.jsxs)(n.p,{children:["\u6b64\u793a\u4f8b\u5b9e\u73b0\u4e86\u4e00\u4e2a\u975e\u5e38\u57fa\u7840\u7684\u57fa\u4e8e axios \u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"})," \u5de5\u5177\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u57fa\u7840 axios baseQuery"',children:"import { createApi } from '@reduxjs/toolkit/query'\nimport type { BaseQueryFn } from '@reduxjs/toolkit/query'\nimport axios from 'axios'\nimport type { AxiosRequestConfig, AxiosError } from 'axios'\n\n// highlight-start\nconst axiosBaseQuery =\n  (\n    { baseUrl }: { baseUrl: string } = { baseUrl: '' },\n  ): BaseQueryFn<\n    {\n      url: string\n      method?: AxiosRequestConfig['method']\n      data?: AxiosRequestConfig['data']\n      params?: AxiosRequestConfig['params']\n      headers?: AxiosRequestConfig['headers']\n    },\n    unknown,\n    unknown\n  > =>\n  async ({ url, method, data, params, headers }) => {\n    try {\n      const result = await axios({\n        url: baseUrl + url,\n        method,\n        data,\n        params,\n        headers,\n      })\n      return { data: result.data }\n    } catch (axiosError) {\n      const err = axiosError as AxiosError\n      return {\n        error: {\n          status: err.response?.status,\n          data: err.response?.data || err.message,\n        },\n      }\n    }\n  }\n// highlight-end\n\nconst api = createApi({\n  // highlight-start\n  baseQuery: axiosBaseQuery({\n    baseUrl: 'https://example.com',\n  }),\n  // highlight-end\n  endpoints(build) {\n    return {\n      query: build.query({ query: () => ({ url: '/query', method: 'get' }) }),\n      mutation: build.mutation({\n        query: () => ({ url: '/mutation', method: 'post' }),\n      }),\n    }\n  },\n})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"graphql-basequery",children:"GraphQL baseQuery"}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e2a\u4f8b\u5b50\u5b9e\u73b0\u4e86\u4e00\u4e2a\u975e\u5e38\u57fa\u7840\u7684\u57fa\u4e8eGraphQL\u7684",(0,s.jsx)(n.code,{children:"baseQuery"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u57fa\u7840\u7684GraphQL baseQuery"',children:"import { createApi } from '@reduxjs/toolkit/query'\nimport { request, gql, ClientError } from 'graphql-request'\n\n// highlight-start\nconst graphqlBaseQuery =\n  ({ baseUrl }: { baseUrl: string }) =>\n  async ({ body }: { body: string }) => {\n    try {\n      const result = await request(baseUrl, body)\n      return { data: result }\n    } catch (error) {\n      if (error instanceof ClientError) {\n        return { error: { status: error.response.status, data: error } }\n      }\n      return { error: { status: 500, data: error } }\n    }\n  }\n// highlight-end\n\nexport const api = createApi({\n  // highlight-start\n  baseQuery: graphqlBaseQuery({\n    baseUrl: 'https://graphqlzero.almansi.me/api',\n  }),\n  // highlight-end\n  endpoints: (builder) => ({\n    getPosts: builder.query({\n      query: () => ({\n        body: gql`\n          query {\n            posts {\n              data {\n                id\n                title\n              }\n            }\n          }\n        `,\n      }),\n      transformResponse: (response) => response.posts.data,\n    }),\n    getPost: builder.query({\n      query: (id) => ({\n        body: gql`\n        query {\n          post(id: ${id}) {\n            id\n            title\n            body\n          }\n        }\n        `,\n      }),\n      transformResponse: (response) => response.post,\n    }),\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u901a\u8fc7\u6269\u5c55fetchbasequery\u81ea\u52a8\u91cd\u65b0\u6388\u6743",children:"\u901a\u8fc7\u6269\u5c55fetchBaseQuery\u81ea\u52a8\u91cd\u65b0\u6388\u6743"}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e2a\u4f8b\u5b50\u5305\u88c5\u4e86",(0,s.jsx)(n.a,{href:"../api/fetchBaseQuery",children:(0,s.jsx)(n.code,{children:"fetchBaseQuery"})}),"\uff0c\u5f53\u9047\u5230",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401",children:(0,s.jsx)(n.code,{children:"401 Unauthorized"})}),"\u9519\u8bef\u65f6\uff0c\u4f1a\u53d1\u9001\u989d\u5916\u7684\u8bf7\u6c42\u5c1d\u8bd5\u5237\u65b0\u6388\u6743\u4ee4\u724c\uff0c\u5e76\u5728\u91cd\u65b0\u6388\u6743\u540e\u91cd\u8bd5\u521d\u59cb\u67e5\u8be2\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u4f7f\u7528\u81ea\u5b9a\u4e49base query\u6a21\u62dfaxios-like\u62e6\u622a\u5668"',children:"// \u6587\u4ef6: authSlice.ts noEmit\ndeclare function tokenReceived(args?: any): void\ndeclare function loggedOut(): void\nexport { tokenReceived, loggedOut }\n// \u6587\u4ef6: baseQueryWithReauth.ts\nimport { fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport type {\n  BaseQueryFn,\n  FetchArgs,\n  FetchBaseQueryError,\n} from '@reduxjs/toolkit/query'\nimport { tokenReceived, loggedOut } from './authSlice'\n\nconst baseQuery = fetchBaseQuery({ baseUrl: '/' })\nconst baseQueryWithReauth: BaseQueryFn<\n  string | FetchArgs,\n  unknown,\n  FetchBaseQueryError\n> = async (args, api, extraOptions) => {\n  let result = await baseQuery(args, api, extraOptions)\n  if (result.error && result.error.status === 401) {\n    // \u5c1d\u8bd5\u83b7\u53d6\u65b0\u7684\u4ee4\u724c\n    const refreshResult = await baseQuery('/refreshToken', api, extraOptions)\n    if (refreshResult.data) {\n      // \u5b58\u50a8\u65b0\u7684\u4ee4\u724c\n      api.dispatch(tokenReceived(refreshResult.data))\n      // \u91cd\u8bd5\u521d\u59cb\u67e5\u8be2\n      result = await baseQuery(args, api, extraOptions)\n    } else {\n      api.dispatch(loggedOut())\n    }\n  }\n  return result\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u9632\u6b62\u591a\u4e2a\u672a\u6388\u6743\u9519\u8bef",children:"\u9632\u6b62\u591a\u4e2a\u672a\u6388\u6743\u9519\u8bef"}),"\n",(0,s.jsxs)(n.p,{children:["\u4f7f\u7528",(0,s.jsx)(n.a,{href:"https://github.com/DirtyHairy/async-mutex",children:(0,s.jsx)(n.code,{children:"async-mutex"})}),"\u9632\u6b62\u5f53\u591a\u4e2a\u8c03\u7528\u56e0",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401",children:(0,s.jsx)(n.code,{children:"401 Unauthorized"})}),"\u9519\u8bef\u5931\u8d25\u65f6\uff0c\u591a\u6b21\u8c03\u7528'/refreshToken'\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"title=\"\u9632\u6b62\u591a\u6b21\u8c03\u7528'/refreshToken'\"",children:"// \u6587\u4ef6: authSlice.ts noEmit\ndeclare function tokenReceived(args?: any): void\ndeclare function loggedOut(): void\nexport { tokenReceived, loggedOut }\n// \u6587\u4ef6: baseQueryWithReauth.ts\n\nimport { fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport type {\n  BaseQueryFn,\n  FetchArgs,\n  FetchBaseQueryError,\n} from '@reduxjs/toolkit/query'\nimport { tokenReceived, loggedOut } from './authSlice'\n// highlight-start\nimport { Mutex } from 'async-mutex'\n// highlight-end\n\n// \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u4e92\u65a5\u9501\n// highlight-start\nconst mutex = new Mutex()\n// highlight-end\nconst baseQuery = fetchBaseQuery({ baseUrl: '/' })\nconst baseQueryWithReauth: BaseQueryFn<\n  string | FetchArgs,\n  unknown,\n  FetchBaseQueryError\n> = async (args, api, extraOptions) => {\n  // \u7b49\u5f85\u4e92\u65a5\u9501\u53ef\u7528\uff0c\u4f46\u4e0d\u9501\u5b9a\u5b83\n  // highlight-start\n  await mutex.waitForUnlock()\n  // highlight-end\n  let result = await baseQuery(args, api, extraOptions)\n  if (result.error && result.error.status === 401) {\n    // \u68c0\u67e5\u4e92\u65a5\u9501\u662f\u5426\u88ab\u9501\u5b9a\n    // highlight-start\n    if (!mutex.isLocked()) {\n      const release = await mutex.acquire()\n      // highlight-end\n      try {\n        const refreshResult = await baseQuery(\n          '/refreshToken',\n          api,\n          extraOptions,\n        )\n        if (refreshResult.data) {\n          api.dispatch(tokenReceived(refreshResult.data))\n          // \u91cd\u8bd5\u521d\u59cb\u67e5\u8be2\n          result = await baseQuery(args, api, extraOptions)\n        } else {\n          api.dispatch(loggedOut())\n        }\n      } finally {\n        // \u4e00\u65e6\u4e92\u65a5\u9501\u5e94\u8be5\u518d\u6b21\u88ab\u91ca\u653e\uff0c\u5fc5\u987b\u8c03\u7528release\u3002\n        // highlight-start\n        release()\n        // highlight-end\n      }\n    } else {\n      // \u7b49\u5f85\u4e92\u65a5\u9501\u53ef\u7528\uff0c\u4f46\u4e0d\u9501\u5b9a\u5b83\n      // highlight-start\n      await mutex.waitForUnlock()\n      // highlight-end\n      result = await baseQuery(args, api, extraOptions)\n    }\n  }\n  return result\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u81ea\u52a8\u91cd\u8bd5",children:"\u81ea\u52a8\u91cd\u8bd5"}),"\n",(0,s.jsxs)(n.p,{children:["RTK Query \u5bfc\u51fa\u4e86\u4e00\u4e2a\u540d\u4e3a ",(0,s.jsx)(n.code,{children:"retry"})," \u7684\u5b9e\u7528\u7a0b\u5e8f\uff0c\u4f60\u53ef\u4ee5\u7528\u5b83\u6765\u5305\u88c5 API \u5b9a\u4e49\u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"baseQuery"}),"\u3002\u5b83\u9ed8\u8ba4\u8fdb\u884c5\u6b21\u5c1d\u8bd5\uff0c\u4f7f\u7528\u57fa\u672c\u7684\u6307\u6570\u9000\u907f\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u9ed8\u8ba4\u884c\u4e3a\u5c06\u5728\u4ee5\u4e0b\u95f4\u9694\u91cd\u8bd5\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"600ms * random(0.4, 1.4)"}),"\n",(0,s.jsx)(n.li,{children:"1200ms * random(0.4, 1.4)"}),"\n",(0,s.jsx)(n.li,{children:"2400ms * random(0.4, 1.4)"}),"\n",(0,s.jsx)(n.li,{children:"4800ms * random(0.4, 1.4)"}),"\n",(0,s.jsx)(n.li,{children:"9600ms * random(0.4, 1.4)"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Retry every request 5 times by default"',children:"import { createApi, fetchBaseQuery, retry } from '@reduxjs/toolkit/query/react'\ninterface Post {\n  id: number\n  name: string\n}\ntype PostsResponse = Post[]\n\n// maxRetries: 5 is the default, and can be omitted. Shown for documentation purposes.\nconst staggeredBaseQuery = retry(fetchBaseQuery({ baseUrl: '/' }), { maxRetries: 5 });\nexport const api = createApi({\n  baseQuery: staggeredBaseQuery,\n  endpoints: (build) => ({\n    getPosts: build.query<PostsResponse, void>({\n      query: () => ({ url: 'posts' }),\n    }),\n    getPost: build.query<PostsResponse, string>({\n      query: (id) => ({ url: `post/${id}` }),\n      extraOptions: { maxRetries: 8 }, // You can override the retry behavior on each endpoint\n    }),\n  }),\n});\n\nexport const { useGetPostsQuery, useGetPostQuery } = api;\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5982\u679c\u4f60\u4e0d\u60f3\u5728\u7279\u5b9a\u7684\u7aef\u70b9\u4e0a\u91cd\u8bd5\uff0c\u4f60\u53ef\u4ee5\u8bbe\u7f6e ",(0,s.jsx)(n.code,{children:"maxRetries: 0"}),"\u3002"]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["\u4e00\u4e2a\u94a9\u5b50\u53ef\u80fd\u540c\u65f6\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"data"})," \u548c ",(0,s.jsx)(n.code,{children:"error"}),"\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cRTK Query \u4f1a\u4fdd\u7559 ",(0,s.jsx)(n.code,{children:"data"})," \u4e2d\u7684\u6700\u540e\u4e00\u4e2a'\u597d'\u7ed3\u679c\uff0c\u76f4\u5230\u5b83\u53ef\u4ee5\u88ab\u66f4\u65b0\u6216\u5783\u573e\u6536\u96c6\u3002"]})}),"\n",(0,s.jsx)(n.h4,{id:"\u9000\u51fa\u9519\u8bef\u91cd\u8bd5",children:"\u9000\u51fa\u9519\u8bef\u91cd\u8bd5"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"retry"})," \u5b9e\u7528\u7a0b\u5e8f\u6709\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"fail"})," \u65b9\u6cd5\u5c5e\u6027\uff0c\u53ef\u4ee5\u7528\u6765\u7acb\u5373\u9000\u51fa\u91cd\u8bd5\u3002\u8fd9\u53ef\u4ee5\u7528\u4e8e\u90a3\u4e9b\u5df2\u77e5\u989d\u5916\u7684\u91cd\u8bd5\u80af\u5b9a\u90fd\u4f1a\u5931\u8d25\u5e76\u4e14\u662f\u591a\u4f59\u7684\u60c5\u51b5\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9000\u51fa\u9519\u8bef\u91cd\u8bd5"',children:"import { createApi, fetchBaseQuery, retry } from '@reduxjs/toolkit/query/react'\nimport type { FetchArgs } from '@reduxjs/toolkit/query'\ninterface Post {\n  id: number\n  name: string\n}\ntype PostsResponse = Post[]\n\n// highlight-start\nconst staggeredBaseQueryWithBailOut = retry(\n  async (args: string | FetchArgs, api, extraOptions) => {\n    const result = await fetchBaseQuery({ baseUrl: '/api/' })(\n      args,\n      api,\n      extraOptions,\n    )\n\n    // \u5982\u679c\u672a\u6388\u6743\uff0c\u7acb\u5373\u9000\u51fa\u91cd\u8bd5\uff0c\n    // \u56e0\u4e3a\u6211\u4eec\u77e5\u9053\u8fde\u7eed\u7684\u91cd\u8bd5\u5c06\u662f\u591a\u4f59\u7684\n    if (result.error?.status === 401) {\n      retry.fail(result.error)\n    }\n\n    return result\n  },\n  {\n    maxRetries: 5,\n  },\n)\n// highlight-end\n\nexport const api = createApi({\n  // highlight-start\n  baseQuery: staggeredBaseQueryWithBailOut,\n  // highlight-end\n  endpoints: (build) => ({\n    getPosts: build.query<PostsResponse, void>({\n      query: () => ({ url: 'posts' }),\n    }),\n    getPost: build.query<Post, string>({\n      query: (id) => ({ url: `post/${id}` }),\n      extraOptions: { maxRetries: 8 }, // \u4f60\u53ef\u4ee5\u5728\u6bcf\u4e2a\u7aef\u70b9\u4e0a\u8986\u76d6\u91cd\u8bd5\u884c\u4e3a\n    }),\n  }),\n})\nexport const { useGetPostsQuery, useGetPostQuery } = api\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u5411\u67e5\u8be2\u6dfb\u52a0\u5143\u4fe1\u606f",children:"\u5411\u67e5\u8be2\u6dfb\u52a0\u5143\u4fe1\u606f"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"baseQuery"})," \u7684\u8fd4\u56de\u503c\u4e5f\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"meta"})," \u5c5e\u6027\u3002\u5728\u4f60\u53ef\u80fd\u5e0c\u671b\u5305\u542b\u4e0e\u8bf7\u6c42\u76f8\u5173\u7684\u989d\u5916\u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u53ef\u80fd\u662f\u6709\u76ca\u7684\uff0c\u4f8b\u5982\u8bf7\u6c42 ID \u6216\u65f6\u95f4\u6233\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fd4\u56de\u503c\u5c06\u5982\u4e0b\u6240\u793a\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u6210\u529f\u7ed3\u679c\u683c\u5f0f\u5e26\u6709\u5143\u4fe1\u606f" no-transpile',children:"return { data: YourData, meta: YourMeta }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u9884\u671f\u7684\u9519\u8bef\u7ed3\u679c\u683c\u5f0f\u5e26\u6709\u5143\u4fe1\u606f" no-transpile',children:"return { error: YourError, meta: YourMeta }\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u5e26\u6709\u5143\u4fe1\u606f\u7684 baseQuery \u793a\u4f8b"',children:"// \u6587\u4ef6: idGenerator.ts noEmit\nexport declare const uuid: () => string\n\n// \u6587\u4ef6: metaBaseQuery.ts\nimport { fetchBaseQuery, createApi } from '@reduxjs/toolkit/query'\nimport type {\n  BaseQueryFn,\n  FetchArgs,\n  FetchBaseQueryError,\n} from '@reduxjs/toolkit/query'\nimport type { FetchBaseQueryMeta } from '@reduxjs/toolkit/dist/query/fetchBaseQuery'\nimport { uuid } from './idGenerator'\n\n// highlight-start\ntype Meta = {\n  requestId: string\n  timestamp: number\n}\n// highlight-end\n\n// highlight-start\nconst metaBaseQuery: BaseQueryFn<\n  string | FetchArgs,\n  unknown,\n  FetchBaseQueryError,\n  {},\n  Meta & FetchBaseQueryMeta\n> = async (args, api, extraOptions) => {\n  const requestId = uuid()\n  const timestamp = Date.now()\n\n  const baseResult = await fetchBaseQuery({ baseUrl: '/' })(\n    args,\n    api,\n    extraOptions,\n  )\n\n  return {\n    ...baseResult,\n    meta: baseResult.meta && { ...baseResult.meta, requestId, timestamp },\n  }\n}\n// highlight-end\n\nconst DAY_MS = 24 * 60 * 60 * 1000\n\ninterface Post {\n  id: number\n  name: string\n  timestamp: number\n}\ntype PostsResponse = Post[]\n\nconst api = createApi({\n  // highlight-start\n  baseQuery: metaBaseQuery,\n  // highlight-end\n  endpoints: (build) => ({\n    // \u4e00\u4e2a\u7406\u8bba\u4e0a\u7684\u7aef\u70b9\uff0c\u6211\u4eec\u53ea\u60f3\u8fd4\u56de\u6570\u636e\n    // \u5982\u679c\u8bf7\u6c42\u662f\u5728\u67d0\u4e2a\u65e5\u671f\u4e4b\u540e\u6267\u884c\u7684\n    getRecentPosts: build.query<PostsResponse, void>({\n      query: () => 'posts',\n      // highlight-start\n      transformResponse: (returnValue: PostsResponse, meta) => {\n        // \u8fd9\u91cc\u7684 `meta` \u5305\u542b\u6211\u4eec\u6dfb\u52a0\u7684 `requestId` \u548c `timestamp`\uff0c\u4ee5\u53ca\n        // fetchBaseQuery \u7684\u5143\u5bf9\u8c61\u7684 `request` \u548c `response`\u3002\n        // \u8fd9\u4e9b\u5c5e\u6027\u53ef\u4ee5\u7528\u6765\u6309\u9700\u8f6c\u6362\u54cd\u5e94\u3002\n        if (!meta) return []\n        return returnValue.filter(\n          (post) => post.timestamp >= meta.timestamp - DAY_MS,\n        )\n      },\n      // highlight-end\n    }),\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u4f7f\u7528-redux-\u72b6\u6001\u6784\u9020\u52a8\u6001\u57fa\u7840-url",children:"\u4f7f\u7528 Redux \u72b6\u6001\u6784\u9020\u52a8\u6001\u57fa\u7840 URL"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u4ece Redux \u72b6\u6001\u7684\u5c5e\u6027\u4e2d\u786e\u5b9a\u4e00\u4e2a\u52a8\u6001\u6539\u53d8\u7684\u57fa\u7840 url\u3002",(0,s.jsx)(n.code,{children:"baseQuery"})," \u53ef\u4ee5\u8bbf\u95ee ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#basequery-function-arguments",children:(0,s.jsx)(n.code,{children:"getState"})})," \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u5728\u88ab\u8c03\u7528\u65f6\u63d0\u4f9b\u5f53\u524d\u7684\u5b58\u50a8\u72b6\u6001\u3002\u8fd9\u53ef\u4ee5\u7528\u6765\u4f7f\u7528\u90e8\u5206 url \u5b57\u7b26\u4e32\u548c\u5b58\u50a8\u72b6\u6001\u4e2d\u7684\u9002\u5f53\u6570\u636e\u6765\u6784\u9020\u6240\u9700\u7684 url\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u52a8\u6001\u751f\u6210\u57fa\u7840 URL \u793a\u4f8b"',children:"// \u6587\u4ef6: src/store.ts noEmit\nexport type RootState = {\n  auth: {\n    projectId: number | null\n  }\n}\n\n// \u6587\u4ef6: src/services/projectSlice.ts noEmit\nimport type { RootState } from '../store'\nexport const selectProjectId = (state: RootState) => state.auth.projectId\n\n// \u6587\u4ef6: src/services/types.ts noEmit\nexport interface Post {\n  id: number\n  name: string\n}\n\n// \u6587\u4ef6: src/services/api.ts\nimport { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport type {\n  BaseQueryFn,\n  FetchArgs,\n  FetchBaseQueryError,\n} from '@reduxjs/toolkit/query/react'\nimport type { Post } from './types'\nimport { selectProjectId } from './projectSlice'\nimport type { RootState } from '../store'\n\nconst rawBaseQuery = fetchBaseQuery({\n  baseUrl: 'www.my-cool-site.com/',\n})\n\nconst dynamicBaseQuery: BaseQueryFn<\n  string | FetchArgs,\n  unknown,\n  FetchBaseQueryError\n> = async (args, api, extraOptions) => {\n  const projectId = selectProjectId(api.getState() as RootState)\n  // \u5f53\u751f\u6210 URL \u7684\u6570\u636e\u7f3a\u5931\u65f6\uff0c\u4f18\u96c5\u5730\u5904\u7406\u60c5\u51b5\n  if (!projectId) {\n    return {\n      error: {\n        status: 400,\n        statusText: 'Bad Request',\n        data: 'No project ID received',\n      },\n    }\n  }\n\n  const urlEnd = typeof args === 'string' ? args : args.url\n  // \u6784\u9020\u4e00\u4e2a\u52a8\u6001\u751f\u6210\u7684 url \u90e8\u5206\n  const adjustedUrl = `project/${projectId}/${urlEnd}`\n  const adjustedArgs =\n    typeof args === 'string' ? adjustedUrl : { ...args, url: adjustedUrl }\n  // \u63d0\u4f9b\u4fee\u6b63\u540e\u7684 url \u548c\u5176\u4ed6\u53c2\u6570\u7ed9\u539f\u59cb\u57fa\u7840\u67e5\u8be2\n  return rawBaseQuery(adjustedArgs, api, extraOptions)\n}\n\nexport const api = createApi({\n  baseQuery: dynamicBaseQuery,\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], void>({\n      query: () => 'posts',\n    }),\n  }),\n})\n\nexport const { useGetPostsQuery } = api\n\n/*\n  \u5f53 Redux \u72b6\u6001\u4e2d\u6709\u4e00\u4e2a `projectId` \u4e3a 500 \u65f6\u4f7f\u7528 `useGetPostsQuery()`\uff0c\n  \u5c06\u4f1a\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u5230 www.my-cool-site.com/project/500/posts\n*/\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"\u793a\u4f8b---transformresponse",children:["\u793a\u4f8b - ",(0,s.jsx)(n.code,{children:"transformResponse"})]}),"\n",(0,s.jsx)(n.h3,{id:"\u89e3\u5305\u6df1\u5ea6\u5d4c\u5957\u7684-graphql-\u6570\u636e",children:"\u89e3\u5305\u6df1\u5ea6\u5d4c\u5957\u7684 GraphQL \u6570\u636e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="GraphQL \u8f6c\u6362\u793a\u4f8b"',children:"// \u6587\u4ef6: graphqlBaseQuery.ts noEmit\nimport { BaseQueryFn } from '@reduxjs/toolkit/query'\ndeclare const graphqlBaseQuery: (args: { baseUrl: string }) => BaseQueryFn\ndeclare const gql: (literals: TemplateStringsArray) => void\nexport { graphqlBaseQuery, gql }\n\n// \u6587\u4ef6: graphqlApi.ts\nimport { createApi } from '@reduxjs/toolkit/query'\nimport { graphqlBaseQuery, gql } from './graphqlBaseQuery'\n\ninterface Post {\n  id: number\n  title: string\n}\n\nexport const api = createApi({\n  baseQuery: graphqlBaseQuery({\n    baseUrl: '/graphql',\n  }),\n  endpoints: (builder) => ({\n    getPosts: builder.query<Post[], void>({\n      query: () => ({\n        body: gql`\n          query {\n            posts {\n              data {\n                id\n                title\n              }\n            }\n          }\n        `,\n      }),\n      // highlight-start\n      transformResponse: (response: { posts: { data: Post[] } }) =>\n        response.posts.data,\n      // highlight-end\n    }),\n  }),\n})\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"\u4f7f\u7528-createentityadapter-\u6807\u51c6\u5316\u6570\u636e",children:["\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"createEntityAdapter"})," \u6807\u51c6\u5316\u6570\u636e"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c",(0,s.jsx)(n.code,{children:"transformResponse"})," \u4e0e ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/api/createEntityAdapter",children:(0,s.jsx)(n.code,{children:"createEntityAdapter"})})," \u4e00\u8d77\u4f7f\u7528\uff0c\u4ee5\u5728\u5c06\u6570\u636e\u5b58\u50a8\u5728\u7f13\u5b58\u4e2d\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u6807\u51c6\u5316\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5bf9\u4e8e\u5982\u4e0b\u7684\u54cd\u5e94\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"no-transpile",children:"[\n  { id: 1, name: 'Harry' },\n  { id: 2, name: 'Ron' },\n  { id: 3, name: 'Hermione' },\n]\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6807\u51c6\u5316\u7684\u7f13\u5b58\u6570\u636e\u5c06\u88ab\u5b58\u50a8\u4e3a\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:"no-transpile",children:'{\n  ids: [1, 3, 2],\n  entities: {\n    1: { id: 1, name: "Harry" },\n    2: { id: 2, name: "Ron" },\n    3: { id: 3, name: "Hermione" },\n  }\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { createEntityAdapter } from '@reduxjs/toolkit'\nimport type { EntityState } from '@reduxjs/toolkit'\n\nexport interface Post {\n  id: number\n  name: string\n}\n\n// highlight-start\nconst postsAdapter = createEntityAdapter<Post>({\n  sortComparer: (a, b) => a.name.localeCompare(b.name),\n})\n// highlight-end\n\nexport const api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  endpoints: (build) => ({\n    getPosts: build.query<EntityState<Post, number>, void>({\n      query: () => `posts`,\n      // highlight-start\n      transformResponse(response: Post[]) {\n        return postsAdapter.addMany(postsAdapter.getInitialState(), response)\n      },\n      // highlight-end\n    }),\n  }),\n})\n\nexport const { useGetPostsQuery } = api\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"\u793a\u4f8b---queryfn",children:["\u793a\u4f8b - ",(0,s.jsx)(n.code,{children:"queryFn"})]}),"\n",(0,s.jsx)(n.h3,{id:"\u4f7f\u7528\u7b2c\u4e09\u65b9-sdk",children:"\u4f7f\u7528\u7b2c\u4e09\u65b9 SDK"}),"\n",(0,s.jsxs)(n.p,{children:["\u8bb8\u591a\u670d\u52a1\uff0c\u5982 Firebase \u548c Supabase\uff0c\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684 SDK \u6765\u8fdb\u884c\u8bf7\u6c42\u3002\u4f60\u53ef\u4ee5\u5728 ",(0,s.jsx)(n.code,{children:"queryFn"})," \u4e2d\u4f7f\u7528\u8fd9\u4e9b SDK \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u57fa\u7840\u7684\u7b2c\u4e09\u65b9 SDK" no-transpile',children:"import { createApi, fakeBaseQuery } from '@reduxjs/toolkit/query/react'\nimport { supabase } from './supabaseApi'\n\nexport const supabaseApi = createApi({\n  reducerPath: 'supabaseApi',\n  baseQuery: fakeBaseQuery(),\n  endpoints: (builder) => ({\n    getBlogs: builder.query({\n      queryFn: async () => {\n        // Supabase \u65b9\u4fbf\u5730\u5df2\u7ecf\u6709\u4e86 `data` \u548c `error` \u5b57\u6bb5\n        const { data, error } = await supabase.from('blogs').select()\n        if (error) {\n          return { error }\n        }\n        return { data }\n      },\n    }),\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4f60\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u521b\u5efa\u4e00\u4e2a\u4f7f\u7528 SDK \u7684\u81ea\u5b9a\u4e49\u57fa\u7840\u67e5\u8be2\uff0c\u5e76\u5b9a\u4e49\u5c06\u65b9\u6cd5\u540d\u6216\u53c2\u6570\u4f20\u5165\u8be5\u57fa\u7840\u67e5\u8be2\u7684\u7aef\u70b9\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684-queryfn",children:"\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684 queryFn"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u6709\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"query"})," \u6216 ",(0,s.jsx)(n.code,{children:"mutation"}),"\uff0c\u5176\u4e2d\u53d1\u9001\u8bf7\u6c42\u6216\u8fd4\u56de\u6570\u636e\u5bf9\u4e8e\u60c5\u51b5\u5e76\u4e0d\u76f8\u5173\u3002\u8fd9\u6837\u7684\u60c5\u51b5\u53ef\u80fd\u662f\u4e3a\u4e86\u5229\u7528 ",(0,s.jsx)(n.code,{children:"invalidatesTags"})," \u5c5e\u6027\u6765\u5f3a\u5236\u91cd\u65b0\u83b7\u53d6\u5df2\u63d0\u4f9b\u7ed9\u7f13\u5b58\u7684\u7279\u5b9a ",(0,s.jsx)(n.code,{children:"tags"}),"\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u53e6\u8bf7\u53c2\u89c1 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/usage/automated-refetching#providing-data-to-the-cache",children:(0,s.jsx)(n.code,{children:"\u63d0\u4f9b\u9519\u8bef\u7ed9\u7f13\u5b58"})})," \u4ee5\u67e5\u770b\u6b64\u7c7b\u60c5\u51b5\u7684\u66f4\u591a\u7ec6\u8282\u548c\u793a\u4f8b\uff0c\u4ee5 '\u91cd\u65b0\u83b7\u53d6\u9519\u8bef\u7684\u67e5\u8be2'\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u4f7f\u7528\u65e0\u64cd\u4f5c\u7684 queryFn"',children:"// \u6587\u4ef6: types.ts noEmit\nexport interface Post {\n  id: number\n  name: string\n}\nexport interface User {\n  id: number\n  name: string\n}\n\n// \u6587\u4ef6: api.ts\nimport { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport type { Post, User } from './types'\n\nconst api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  tagTypes: ['Post', 'User'],\n  endpoints: (build) => ({\n    getPosts: build.query<Post[], void>({\n      query: () => 'posts',\n      providesTags: ['Post'],\n    }),\n\n    getUsers: build.query<User[], void>({\n      query: () => 'users',\n      providesTags: ['User'],\n    }),\n\n    // highlight-start\n    refetchPostsAndUsers: build.mutation<null, void>({\n      // \u8fd9\u91cc\u7684\u67e5\u8be2\u4e0d\u76f8\u5173\uff0c\u6240\u4ee5\u4f7f\u7528\u4e86\u4e00\u4e2a\u8fd4\u56de `null` \u7684 `queryFn`\n      queryFn: () => ({ data: null }),\n      // \u8fd9\u4e2a mutation \u5229\u7528\u4e86\u6807\u7b7e\u5931\u6548\u884c\u4e3a\u6765\u89e6\u53d1\n      // \u4efb\u4f55\u63d0\u4f9b 'Post' \u6216 'User' \u6807\u7b7e\u7684\u67e5\u8be2\u91cd\u65b0\u83b7\u53d6\uff0c\u5982\u679c\u67e5\u8be2\n      // \u5f53\u524d\u8ba2\u9605\u4e86\u7f13\u5b58\u7684\u6570\u636e\n      invalidatesTags: ['Post', 'User'],\n    }),\n    // highlight-end\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u65e0\u521d\u59cb\u8bf7\u6c42\u7684\u6570\u636e\u6d41",children:"\u65e0\u521d\u59cb\u8bf7\u6c42\u7684\u6570\u636e\u6d41"}),"\n",(0,s.jsxs)(n.p,{children:["RTK Query \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7aef\u70b9\u53d1\u9001\u521d\u59cb\u6570\u636e\u8bf7\u6c42\u7684\u80fd\u529b\uff0c\u7136\u540e\u7528\u5b9a\u671f\u7684",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/usage/streaming-updates",children:"\u6d41\u5f0f\u66f4\u65b0"}),"\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u7f13\u5b58\u6570\u636e\u66f4\u65b0\u3002\u7136\u800c\uff0c\u521d\u59cb\u8bf7\u6c42\u662f\u53ef\u9009\u7684\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u5728\u6ca1\u6709\u4efb\u4f55\u521d\u59cb\u8bf7\u6c42\u88ab\u89e6\u53d1\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u6d41\u5f0f\u66f4\u65b0\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"queryFn"})," \u88ab\u7528\u6765\u7528\u4e00\u4e2a\u7a7a\u6570\u7ec4\u586b\u5145\u7f13\u5b58\u6570\u636e\uff0c\u6ca1\u6709\u53d1\u9001\u521d\u59cb\u8bf7\u6c42\u3002\u6570\u7ec4\u7a0d\u540e\u901a\u8fc7 ",(0,s.jsx)(n.a,{href:"/redux-toolkit-zh/rtk-query/api/createApi#oncacheentryadded",children:(0,s.jsx)(n.code,{children:"onCacheEntryAdded"})})," \u7aef\u70b9\u9009\u9879\u4f7f\u7528\u6d41\u5f0f\u66f4\u65b0\u8fdb\u884c\u586b\u5145\uff0c\u63a5\u6536\u5230\u6570\u636e\u65f6\u66f4\u65b0\u7f13\u5b58\u6570\u636e\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u65e0\u521d\u59cb\u8bf7\u6c42\u7684\u6570\u636e\u6d41"',children:"// \u6587\u4ef6: types.ts noEmit\nexport interface Message {\n  id: number\n  channel: 'general' | 'redux'\n  userName: string\n  text: string\n}\n\n// \u6587\u4ef6: api.ts\nimport { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport type { Message } from './types'\n\nconst api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/' }),\n  tagTypes: ['Message'],\n  endpoints: (build) => ({\n    // highlight-start\n    streamMessages: build.query<Message[], void>({\n      // \u8fd9\u91cc\u7684\u67e5\u8be2\u4e0d\u76f8\u5173\uff0c\u56e0\u4e3a\u6570\u636e\u5c06\u901a\u8fc7\u6d41\u5f0f\u66f4\u65b0\u63d0\u4f9b\u3002\n      // \u4f7f\u7528\u8fd4\u56de\u7a7a\u6570\u7ec4\u7684 queryFn\uff0c\u5185\u5bb9\u5c06\u901a\u8fc7\n      // \u4e0b\u9762\u7684\u6d41\u5f0f\u66f4\u65b0\u586b\u5145\uff0c\u5f53\u5b83\u4eec\u88ab\u63a5\u6536\u65f6\u3002\n      queryFn: () => ({ data: [] }),\n      async onCacheEntryAdded(arg, { updateCachedData, cacheEntryRemoved }) {\n        const ws = new WebSocket('ws://localhost:8080')\n        // \u5f53\u4ece websocket \u63a5\u6536\u5230\u6d88\u606f\u65f6\uff0c\u586b\u5145\u6570\u7ec4\n        ws.addEventListener('message', (event) => {\n          updateCachedData((draft) => {\n            draft.push(JSON.parse(event.data))\n          })\n        })\n        await cacheEntryRemoved\n        ws.close()\n      },\n    }),\n    // highlight-end\n  }),\n})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42",children:"\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u7f16\u5199\u4e86\u4e00\u4e2a\u67e5\u8be2\u6765\u83b7\u53d6\u968f\u673a\u7528\u6237\u7684\u6240\u6709\u5e16\u5b50\u3002\u8fd9\u662f\u901a\u8fc7\u9996\u5148\u8bf7\u6c42\u4e00\u4e2a\u968f\u673a\u7528\u6237\uff0c\u7136\u540e\u83b7\u53d6\u8be5\u7528\u6237\u7684\u6240\u6709\u5e16\u5b50\u6765\u5b8c\u6210\u7684\u3002\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"queryFn"})," \u5141\u8bb8\u5c06\u4e24\u4e2a\u8bf7\u6c42\u5305\u542b\u5728\u4e00\u4e2a\u67e5\u8be2\u4e2d\uff0c\u907f\u514d\u5728\u7ec4\u4ef6\u4ee3\u7801\u4e2d\u94fe\u63a5\u8be5\u903b\u8f91\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="\u4f7f\u7528\u5355\u4e2a\u67e5\u8be2\u6267\u884c\u591a\u4e2a\u8bf7\u6c42"',children:"// \u6587\u4ef6: types.ts noEmit\nexport interface Post {}\nexport interface User {\n  id: number\n}\n\n// \u6587\u4ef6: api.ts\nimport { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query'\nimport type { FetchBaseQueryError } from '@reduxjs/toolkit/query'\nimport type { Post, User } from './types'\n\nconst api = createApi({\n  baseQuery: fetchBaseQuery({ baseUrl: '/ ' }),\n  endpoints: (build) => ({\n    getRandomUserPosts: build.query<Post, void>({\n      async queryFn(_arg, _queryApi, _extraOptions, fetchWithBQ) {\n        // \u83b7\u53d6\u4e00\u4e2a\u968f\u673a\u7528\u6237\n        const randomResult = await fetchWithBQ('users/random')\n        if (randomResult.error)\n          return { error: randomResult.error as FetchBaseQueryError }\n        const user = randomResult.data as User\n        const result = await fetchWithBQ(`user/${user.id}/posts`)\n        return result.data\n          ? { data: result.data as Post }\n          : { error: result.error as FetchBaseQueryError }\n      },\n    }),\n  }),\n})\n"})})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var s=r(6540);const t={},a=s.createContext(t);function i(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);